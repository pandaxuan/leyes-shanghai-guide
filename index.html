<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Leyes - å‡æœ›æ˜Ÿæ²³</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>

    <style>

        body { margin: 0; background: #000205; color: white; overflow: hidden; font-family: "PingFang SC", "STHeiti", "Microsoft YaHei", sans-serif; -webkit-tap-highlight-color: transparent; }

        #canvas-container { position: fixed; inset: 0; z-index: 0; }

        #fixed-nav { position: fixed; top: 0; left: 0; right: 0; z-index: 50; pointer-events: none; }

        #main-ui { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; pointer-events: none; }

        #chat-history { flex-grow: 1; margin-top: 80px; margin-bottom: 110px; overflow-y: auto; padding: 0 1.5rem; pointer-events: auto; mask-image: linear-gradient(to bottom, transparent, black 8%, black 92%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 8%, black 92%, transparent); scroll-behavior: smooth; }

        .glass-card { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 0 50px rgba(0, 0, 0, 0.6); pointer-events: auto; }

        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .music-spinning { animation: rotate-slow 4s linear infinite; }

        @keyframes ethereal-fade { from { opacity: 0; filter: blur(12px); transform: translateY(15px) scale(1.05); } to { opacity: 1; filter: blur(0); transform: translateY(0) scale(1); } }

        .ethereal-text { animation: ethereal-fade 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .center-tracking { padding-left: 0.8em; }

        @media (max-width: 640px) {

            #chat-history { margin-top: 70px; margin-bottom: 90px; }

            .mobile-title { font-size: 2.2rem !important; letter-spacing: 0.6em !important; padding-left: 0.6em !important; }

            .mobile-subtitle { font-size: 9px !important; letter-spacing: 0.3em !important; white-space: nowrap; }

            .mobile-text { font-size: 1rem !important; font-weight: 300 !important; color: rgba(255,255,255,0.9) !important; }

        }

        @keyframes lavaMove { 0% { transform: translate(-20%, -20%) scale(1); } 100% { transform: translate(20%, 20%) scale(1.2); } }

        @keyframes sparkle { 0% { opacity: 0.1; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1.2); } }

        .lava-container { mask-image: radial-gradient(circle at center, black 30%, transparent 100%); filter: contrast(150%) brightness(120%); }
        /* å›¾ç‰‡å‘¼å¸æ„ŸåŠ¨ç”» */
.oracle-image-load {
    animation: image-bloom 4s ease-out forwards;
}

@keyframes image-bloom {
    from { filter: blur(20px) brightness(0); transform: scale(1.1); }
    to { filter: blur(0) brightness(1); transform: scale(1); }
}

    </style>

</head>

<body>

    <div id="canvas-container"></div>

    <audio id="bgm" loop src="bgm.mp3"></audio>

    <div id="fixed-nav">

        <nav class="p-6 sm:p-10 flex justify-between items-center pointer-events-auto">

            <h1 class="text-lg sm:text-xl font-thin tracking-[0.4em] text-white/70 uppercase italic">Leyes.</h1>

            <div class="flex items-center gap-3 sm:gap-6">

                <button id="music-btn" onclick="toggleMusic()" class="glass-card flex items-center gap-2 text-white/60 px-4 py-2.5 rounded-full border border-white/5 transition-all">

                    <div id="music-icon-container"><i data-lucide="music" class="w-3 h-3 sm:w-4 sm:h-4"></i></div>

                    <span class="text-[9px] sm:text-[10px] tracking-[0.3em] uppercase">æ˜Ÿæ²³éŸ³ä¹</span>

                </button>

                <button onclick="askTheUniverse()" class="glass-card text-white/80 px-6 sm:px-10 py-2.5 sm:py-3 rounded-full text-[10px] tracking-[0.5em] border border-white/10 hover:bg-white/10 transition-all duration-1000">è¯¢é—®æ˜Ÿæ²³</button>

            </div>

        </nav>

    </div>

    <div id="main-ui">

        <div id="chat-history" class="no-scrollbar max-w-2xl mx-auto w-full">

            <div id="header-section" class="text-center pt-24 pb-20 sm:pt-32 sm:pb-32 ethereal-text">

                <h2 class="text-3xl sm:text-5xl font-thin tracking-[0.8em] sm:tracking-[1.2em] mb-8 text-white/80 mobile-title center-tracking">å‡æœ›æ˜Ÿæ²³</h2>

                <div class="flex justify-center items-center gap-3 px-4">

                    <div class="h-[1px] flex-grow max-w-[40px] bg-white/10"></div>

                    <p class="text-white/40 tracking-[0.4em] text-[10px] sm:text-xs uppercase mobile-subtitle">æ—¶é—´æ‰ç¢åœ¨ç’€ç’¨æ˜Ÿæ²³ï¼Œè€Œæˆ‘ä¸€ç›´åœ¨ä½ èº«è¾¹</p>

                    <div class="h-[1px] flex-grow max-w-[40px] bg-white/10"></div>

                </div>

            </div>

            <div id="message-container" class="space-y-12 pb-20"></div>

        </div>

    </div>

    <div class="fixed bottom-0 left-0 right-0 p-8 sm:p-16 z-50">

        <div class="max-w-xl mx-auto flex gap-4 items-center glass-card p-3 sm:p-3 rounded-full border-white/10">

            <input type="text" id="user-input" class="flex-grow bg-transparent text-white px-5 sm:px-8 py-2 outline-none placeholder:text-white/20 text-sm tracking-[0.2em] font-light" placeholder="æŠŠæœªè¯´å®Œçš„è¯ï¼Œå†™ç»™æ˜Ÿæ²³...">

            <button id="send-btn" class="text-white/40 hover:text-white transition-all duration-700 p-1">

                <i data-lucide="arrow-up-circle" class="w-8 h-8 stroke-[1px]"></i>

            </button>

        </div>

    </div>

    <div id="fortune-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-black/95 backdrop-blur-2xl">

        <div class="max-w-md w-full text-center ethereal-text">

            <div class="text-white/20 mb-10 tracking-[1.5em] text-[10px] uppercase font-thin">æ˜Ÿæ²³çš„å¯ç¤º</div>

            <p id="fortune-text" class="text-xl font-thin leading-loose text-white/90 mb-16 tracking-[0.4em] px-4 mobile-text"></p>

            <button onclick="closeFortune()" class="text-white/30 hover:text-white text-[11px] tracking-[0.6em] uppercase transition-all duration-1000">[ é—­ä¸ŠåŒçœ¼ ]</button>

        </div>

    </div>

    <script>

        const BACKEND_URL = 'https://leyes-shanghai-guide.onrender.com';

        const bgm = document.getElementById('bgm');

        const musicBtn = document.getElementById('music-btn');

        const musicIconContainer = document.getElementById('music-icon-container');
        const ritualQuestions = [
    { q: "æ·±æ¸Šä¸­æœ‰ä¸€æŸå…‰ï¼Œä½ è®¤ä¸ºé‚£æ˜¯ï¼š", a: ["è¿‡å¾€çš„å€’å½±", "ç¥ç¥‡çš„å‚æ€œ", "å‡ºå£çš„æš—ç¤º", "è‡ªæˆ‘çš„ç‡ƒçƒ§"] },
    { q: "è‹¥èƒ½å¸¦èµ°ä¸€ç§å£°éŸ³ï¼Œä½ ä¼šé€‰æ‹©ï¼š", a: ["è½é›¨æ•²å‡»é’çŸ³", "çˆ±äººçš„å‘¢å–ƒ", "å®‡å®™çš„å¯‚é™", "è¿œè¡Œçš„é£å£°"] },
    { q: "æ­¤è¡Œç»ˆç‚¹ï¼Œä½ æœ€æƒ³å¯»å›ï¼š", a: ["æœ€åˆçš„å‹‡æ°”", "é—å¤±çš„å§“å", "ä¸ç­çš„ç¯ç«", "æ— åçš„è‡ªç”±"] },
    { q: "è‹¥æ˜Ÿæ²³æœ‰é¢œè‰²ï¼Œæ­¤åˆ»ä½ çœ¼ä¸­æ˜¯ï¼š", a: ["å¹½é‚ƒçš„è“", "ç‚½çƒ­çš„ç™½", "æ­»å¯‚çš„é»‘", "è™šæ— çš„é“¶"] }
];

let currentStep = 0;
let userChoices = [];
let isRitualActive = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨è¿›è¡Œä»ªå¼

        let isPlaying = false;

        let chatContext = []; 

        let idleTimer = null; 

        let autoMessageCount = 0;

        let hasName = false;

        let userName = "";

        const MAX_AUTO_MESSAGES = 10;

        const IDLE_TIME = 60000;

        function toggleMusic() {

            if (isPlaying) { bgm.pause(); musicIconContainer.classList.remove('music-spinning'); musicBtn.style.opacity = "0.4"; }

            else { bgm.play().catch(e => {}); musicIconContainer.classList.add('music-spinning'); musicBtn.style.opacity = "1"; }

            isPlaying = !isPlaying;

        }

        function resetIdleTimer() {

            if (idleTimer) clearTimeout(idleTimer);

            if (!hasName || autoMessageCount >= MAX_AUTO_MESSAGES) return;

            idleTimer = setTimeout(() => {

                const topics = ["æ„Ÿå¹å½“ä¸‹çš„å¯‚é™ä¸æ˜Ÿå…‰", "æ¢è®¨æ—…äººæ²‰é»˜èƒŒåçš„æ€ç»ª", "å¼•ç”¨ä¸€æ®µå…³äºå®‡å®™ã€æ—¶é—´æˆ–å­¤ç‹¬çš„ç©ºçµå“²æ€", "è¯¢é—®æ—…äººæ­¤åˆ»æ˜¯å¦åœ¨å¬é‚£è¿œå¤çš„æ˜Ÿå£°", "è§‚å¯Ÿæ˜Ÿäº‘çš„æµåŠ¨ï¼Œå¹¶åˆ†äº«ä¸€ç§è½¬ç¬å³é€çš„ç¾æ„Ÿ", "æ¢è®¨è®°å¿†ä¸å…‰å¹´çš„å…³ç³»", "æ¸©æŸ”åœ°æé†’æ—…äººï¼Œæ— è®ºå¤šä¹…ï¼Œæ˜Ÿæ²³éƒ½ä¼šåœ¨æ­¤å®ˆå€™"];

                const randomTopic = topics[Math.floor(Math.random() * topics.length)];

                const idlePrompt = `æ—…äººå·²æ²‰æ€è®¸ä¹…ã€‚è¯·ä½œä¸ºæ˜Ÿæ²³å®ˆæŠ¤è€…ï¼ŒåŸºäºâ€œ${randomTopic}â€è¿™ä¸ªä¸»é¢˜ä¸»åŠ¨å‘èµ·ä¸€æ®µå¯¹è¯ã€‚è¦æ±‚ï¼šè¯­è¨€æåº¦ä¼˜ç¾ã€ç©ºçµï¼Œä¸è¦é‡å¤ä¹‹å‰è¯´è¿‡çš„è¯ï¼Œå­—æ•°æ§åˆ¶åœ¨30å­—å·¦å³ã€‚`;

                autoMessageCount++;

                sendToAI(idlePrompt, true);

            }, IDLE_TIME);

        }

        function showVisualOracle(prompt) {
    const container = document.getElementById('message-container');
    const history = document.getElementById('chat-history');
    const imageId = 'oracle-' + Date.now();

    // é¢„å¤„ç† Promptï¼ŒåŠ ä¸Šæ˜Ÿæ²³æ»¤é•œå…³é”®è¯
    const refinedPrompt = encodeURIComponent(`ethereal cosmic style, ${prompt}, ultra-detailed, deep space nebula background, soft glow`);
    // ä½¿ç”¨å…è´¹æ¥å£ï¼šhttps://pollinations.ai/p/[prompt]
    const imageUrl = `https://pollinations.ai/p/${refinedPrompt}?width=512&height=512&seed=${Math.floor(Math.random()*1000)}&nologo=true`;

    const html = `
        <div id="${imageId}-container" class="mb-10 ethereal-text" style="animation-delay: 1s">
            <div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-4 center-tracking">æ˜Ÿè±¡ç»“æ™¶</div>
            <div class="relative w-full aspect-square max-w-sm mx-auto overflow-hidden rounded-2xl glass-card border border-white/10 shadow-2xl shadow-blue-900/20">
                <img id="${imageId}" 
                     class="w-full h-full object-cover opacity-0 transition-opacity duration-[3000ms]" 
                     src="${imageUrl}" 
                     onload="this.style.opacity='1'" />
                <div class="absolute inset-0 pointer-events-none bg-gradient-to-t from-black/40 to-transparent"></div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', html);
    
    setTimeout(() => {
        history.scrollTo({ top: history.scrollHeight, behavior: 'smooth' });
    }, 500);
}

        async function handleStream(res, element) {
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    const history = document.getElementById('chat-history');
    let fullContent = ""; 
    let displayContent = ""; // ç”¨äºå®é™…æ˜¾ç¤ºçš„æ–‡æœ¬
    element.innerText = "";

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');

        for (const line of lines) {
            if (line.startsWith('data: ')) {
                try {
                    const jsonStr = line.substring(6).trim();
                    if (!jsonStr) continue;
                    const data = JSON.parse(jsonStr);
                    
                    if (data.text) {
                        fullContent += data.text;

                        // ğŸŒŸ æ ¸å¿ƒä¼˜åŒ–ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»å¼€å§‹è¾“å‡ºç»˜å›¾æŒ‡ä»¤
                        if (fullContent.includes("DRAW_PROMPT:")) {
                            // å°†æŒ‡ä»¤å‰çš„æ–‡å­—æ­£å¸¸æ˜¾ç¤º
                            const parts = fullContent.split("DRAW_PROMPT:");
                            displayContent = parts[0];
                            element.innerText = displayContent;
                            
                            // å¦‚æœæµå·²ç»ç»“æŸï¼ˆç”±åç«¯æ§åˆ¶æˆ–æ£€æµ‹åˆ°å®Œæ•´ promptï¼‰
                            // å®é™…å›¾ç‰‡ç”Ÿæˆå°†åœ¨ fullContent æœ€ç»ˆå®Œæˆåè§¦å‘
                        } else {
                            displayContent += data.text;
                            element.innerText = displayContent;
                        }
                        
                        history.scrollTo({ top: history.scrollHeight, behavior: 'auto' });
                    }
                    
                    if (data.end) {
                        // ğŸŒŸ è§£ç­¾ç»“æŸï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç»˜å›¾éœ€æ±‚
                        if (fullContent.includes("DRAW_PROMPT:")) {
                            const prompt = fullContent.split("DRAW_PROMPT:")[1].trim();
                            // è¿™é‡Œçš„ prompt å³ä½¿å¸¦æœ‰æ ‡ç‚¹ä¹Ÿæ²¡å…³ç³»ï¼ŒshowVisualOracle ä¼šå¤„ç†
                            showVisualOracle(prompt);
                        }
                    }
                } catch (e) {
                    console.error("è§£ææµæ•°æ®å‡ºé”™", e);
                }
            }
        }
    }
    return fullContent;
}

        async function sendToAI(userMessage, isAuto = false) {

            const container = document.getElementById('message-container');

            const history = document.getElementById('chat-history');

            const uniqueId = 'ai-' + Date.now();

            container.insertAdjacentHTML('beforeend', `<div class="mb-10 ethereal-text"><div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-2 center-tracking">æ˜Ÿå“</div><div id="${uniqueId}" class="text-white/60 font-thin text-base tracking-[0.1em] italic mobile-text">è†å¬ç¾¤æ˜Ÿ...</div></div>`);

            const aiDisplay = document.getElementById(uniqueId);

            history.scrollTo({ top: history.scrollHeight, behavior: 'smooth' });

            try {
            // --- ä¼˜åŒ–åçš„åå­—è¯†åˆ«é€»è¾‘ ---
            if (!hasName) {
                // æ£€æŸ¥ä¸Šä¸‹æ–‡ï¼Œçœ‹çœ‹ä¸Šä¸€ä¸ª AI çš„è¯æ˜¯ä¸æ˜¯åœ¨é—®åå­—
                const lastAIResponse = chatContext.findLast(m => m.role === "assistant")?.content || "";
                
                // åªè¦ä¸Šä¸ªå›å¤åŒ…å«â€œåå­—â€äºŒå­—ï¼Œä¸”å½“å‰ä¸æ˜¯è‡ªåŠ¨è§¦å‘çš„æ¶ˆæ¯
                if ((lastAIResponse.includes("åå­—") || lastAIResponse.includes("è°åœ¨å‘å…‰")) && !isAuto) {
                    userName = userMessage.replace(/æˆ‘å«|æˆ‘æ˜¯|å«æˆ‘|åå­—æ˜¯|ã€‚/g, "").trim();
                    hasName = true;
                    
                    // åå­—è¯†åˆ«æˆåŠŸåï¼Œå»¶è¿Ÿ 2 ç§’å¯åŠ¨ä»ªå¼
                    setTimeout(() => {
                        if (typeof startRitual === 'function') startRitual();
                    }, 2000);
                }
            }

                let processedMessage = userMessage;

                let systemPrompt = "ä½ æ˜¯ä¸€ä¸ªç©ºçµçš„æ˜Ÿæ²³å®ˆæŠ¤è€…ã€‚Leyesæ˜¯ä½ çš„åå­—ã€‚";

                if (hasName) {

                    processedMessage = `${userMessage} ï¼ˆæ³¨æ„ï¼šæˆ‘æ˜¯${userName}ï¼Œè¯·åœ¨å›å¤çš„å¼€å¤´æˆ–ç»“å°¾è‡ªç„¶åœ°ç§°å‘¼æ—…äººçš„åå­—ï¼‰`;

                    systemPrompt += `å½“å‰æ—…äººåå­—å«â€œ${userName}â€ã€‚ä½ å¿…é¡»åœ¨æ¯ä¸€å¥å›å¤ä¸­éƒ½åŒ…å«è¿™ä¸ªåå­—ã€‚`;

                }

                const res = await fetch(`${BACKEND_URL}/api/chat`, {

                    method: 'POST',

                    headers: { 'Content-Type': 'application/json' },

                    body: JSON.stringify({ message: processedMessage, messages: [{ role: "system", content: systemPrompt }, ...chatContext, { role: "user", content: processedMessage }], language: 'zh' }),

                });

                const finalResponse = await handleStream(res, aiDisplay);

                aiDisplay.classList.remove('italic');

                chatContext.push({role: "user", content: userMessage});

                chatContext.push({role: "assistant", content: finalResponse});

                if (chatContext.length > 20) chatContext = chatContext.slice(-20);

                resetIdleTimer();

            } catch (e) { aiDisplay.innerText = "ä¿¡å·åœ¨å…‰å¹´å¤–è¿·å¤±äº†..."; }

        }

        const handleSend = async () => {
    const input = document.getElementById('user-input');
    const message = input.value.trim();
    if (!message) return;

    if (idleTimer) clearTimeout(idleTimer);

    // --- æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦æºå¸¦é‡‡æ ·æ•°æ® ---
    let finalPrompt = message;
    
    // å¦‚æœ userChoices å·²ç»å­˜æ»¡äº†é¢˜ç›®ï¼ˆ4é“é¢˜ï¼‰ï¼Œè¯´æ˜è¿™æ˜¯ç­”å®Œé¢˜åçš„ç¬¬ä¸€æ¬¡æé—®
    if (userChoices.length === ritualQuestions.length) {
        finalPrompt = `ã€æ˜Ÿè¾°é‡‡æ ·æ•°æ®ã€‘ï¼š${userChoices.join('ï¼›')}\nã€æ—…äººå¿ƒä¸­æ‰€æ±‚ã€‘ï¼š${message}\nè¯·ç»“åˆä»¥ä¸Šé‡‡æ ·æ•°æ®ï¼Œä¸ºæˆ‘è¿›è¡Œæ·±åº¦çš„è§£ç­¾ã€‚`;
        
        // å‘é€å®Œåæ¸…ç©ºé‡‡æ ·ï¼Œé˜²æ­¢ä¸‹æ¬¡å¯¹è¯è¿˜å¸¦ç€è¿™äº›æ•°æ®
        userChoices = []; 
        // æ¢å¤è¾“å…¥æ¡†æç¤º
        input.placeholder = "æŠŠæœªè¯´å®Œçš„è¯ï¼Œå†™ç»™æ˜Ÿæ²³...";
    }

    const container = document.getElementById('message-container');
    container.insertAdjacentHTML('beforeend', `<div class="mb-10"><div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-2 center-tracking">å©é—®</div><div class="text-white/80 font-thin text-base tracking-[0.1em] mobile-text">${message}</div></div>`);
    
    input.value = "";
    
    // æ³¨æ„ï¼šè¿™é‡Œä¼ ç»™ AI çš„æ˜¯æ‹¼è£…åçš„ finalPrompt
    await sendToAI(finalPrompt);
};

        async function askTheUniverse() {

            if (typeof applyLavaEffect === 'function') applyLavaEffect();

            if (idleTimer) clearTimeout(idleTimer);

            const modal = document.getElementById('fortune-modal');

            const txt = document.getElementById('fortune-text');

            modal.classList.remove('hidden');

            txt.innerText = "æ­£åœ¨æ‹¨å¼€æ˜Ÿäº‘...";

            try {

                const res = await fetch(`${BACKEND_URL}/api/chat`, {

                    method: 'POST',

                    headers: { 'Content-Type': 'application/json' },

                    body: JSON.stringify({ message: "è¯·ä½œä¸ºè¿™ç‰‡æ˜Ÿæ²³çš„å®ˆæŠ¤è€…ï¼Œä¸ºæˆ‘å†™ä¸€é¦–å¤§çº¦åè¡Œçš„å¯ç¤ºä¹‹è¯—ã€‚é£æ ¼è¦ç©ºçµã€æ·±é‚ƒã€å¸¦æœ‰å“²æ€ï¼Œä¸éœ€è¦æ ‡é¢˜ã€‚", language: 'zh' }),

                });

                await handleStream(res, txt);

                resetIdleTimer();

            } catch (e) { txt.innerText = "æ˜Ÿå°˜æ¼«è¿‡ï¼Œè¯·ç¨åå†è¯•ã€‚"; }

        }

        function closeFortune() { document.getElementById('fortune-modal').classList.add('hidden'); resetIdleTimer(); }

        document.getElementById('user-input').addEventListener('input', () => { if (idleTimer) clearTimeout(idleTimer); });

        document.getElementById('send-btn').onclick = handleSend;

        document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });

        let scene, camera, renderer, particles, mouse = new THREE.Vector2(), targetMouse = new THREE.Vector2();

        const PARTICLE_COUNT = window.innerWidth < 640 ? 4500 : 12000;

        function createGlowTexture() {

            const canvas = document.createElement('canvas');

            canvas.width = 64; canvas.height = 64;

            const ctx = canvas.getContext('2d');

            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);

            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');

            gradient.addColorStop(0.3, 'rgba(255, 255, 255, 0.7)');

            gradient.addColorStop(0.6, 'rgba(255, 255, 255, 0.2)');

            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            ctx.fillStyle = gradient; ctx.fillRect(0, 0, 64, 64);

            return new THREE.CanvasTexture(canvas);

        }

        function initThree() {

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);

            camera.position.z = 7;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });

            renderer.setSize(window.innerWidth, window.innerHeight);

            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const geo = new THREE.BufferGeometry();

            const pos = new Float32Array(PARTICLE_COUNT * 3);

            const colors = new Float32Array(PARTICLE_COUNT * 3);

            const originalColors = new Float32Array(PARTICLE_COUNT * 3);

            const palette = [new THREE.Color('#ffffff'), new THREE.Color('#ffffff'), new THREE.Color('#bae6fd'), new THREE.Color('#e9d5ff')];

            for (let i = 0; i < PARTICLE_COUNT; i++) {

                pos[i*3] = (Math.random() - 0.5) * 20; pos[i*3+1] = (Math.random() - 0.5) * 20; pos[i*3+2] = (Math.random() - 0.5) * 10;

                const col = palette[Math.floor(Math.random() * palette.length)];

                colors[i*3] = originalColors[i*3] = col.r; colors[i*3+1] = originalColors[i*3+1] = col.g; colors[i*3+2] = originalColors[i*3+2] = col.b;

            }

            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));

            geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            geo.setAttribute('originalColor', new THREE.BufferAttribute(originalColors, 3));

            const mat = new THREE.PointsMaterial({ size: window.innerWidth < 640 ? 0.08 : 0.035, map: createGlowTexture(), vertexColors: true, transparent: true, opacity: window.innerWidth < 640 ? 0.7 : 0.5, blending: THREE.AdditiveBlending, depthWrite: false, sizeAttenuation: true });

            particles = new THREE.Points(geo, mat);

            scene.add(particles);

            const handleMove = (x, y) => { targetMouse.x = (x / window.innerWidth) * 2 - 1; targetMouse.y = -(y / window.innerHeight) * 2 + 1; };

            window.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY));

            window.addEventListener('touchmove', (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY), { passive: true });

        }

        function animate() {

            requestAnimationFrame(animate);

            mouse.lerp(targetMouse, 0.02);

            const positions = particles.geometry.attributes.position.array;

            const colors = particles.geometry.attributes.color.array;

            const originals = particles.geometry.attributes.originalColor.array;

            const time = Date.now() * 0.0003;

            for (let i = 0; i < PARTICLE_COUNT; i++) {

                const i3 = i * 3;

                positions[i3] += Math.sin(time + i) * 0.0004; positions[i3+1] += Math.cos(time + i) * 0.0004;

                const flicker = 0.8 + Math.sin(time * 5 + i) * 0.2;

                colors[i3] = originals[i3] * flicker; colors[i3+1] = originals[i3+1] * flicker; colors[i3+2] = originals[i3+2] * flicker;

                const dx = positions[i3] - (mouse.x * 6); const dy = positions[i3+1] - (mouse.y * 4);

                const distSq = dx*dx + dy*dy;

                if (distSq < 3) { const dist = Math.sqrt(distSq); const force = (1.5 - dist) / 1.5; positions[i3] += dx * force * 0.01; positions[i3+1] += dy * force * 0.01; }

            }

            particles.geometry.attributes.position.needsUpdate = true;

            particles.geometry.attributes.color.needsUpdate = true;

            particles.rotation.y += 0.0002;

            renderer.render(scene, camera);

        }
        function startRitual() {
    isRitualActive = true;
    currentStep = 0;
    userChoices = [];
    showNextQuestion();
}

function showNextQuestion() {
    const container = document.getElementById('message-container');
    const history = document.getElementById('chat-history');
    const qObj = ritualQuestions[currentStep];

    const html = `
        <div class="mb-10 ethereal-text ritual-step">
            <div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-2 center-tracking">æ˜Ÿé‡‡æ · ${currentStep + 1}/${ritualQuestions.length}</div>
            <div class="text-white/80 font-light text-lg tracking-[0.1em] mb-6">${qObj.q}</div>
            <div class="flex flex-wrap gap-3">
                ${qObj.a.map(choice => `
                    <button onclick="handleChoice('${choice}')" 
                            class="glass-card px-6 py-3 rounded-full text-[13px] text-white/80 bg-white/5 border border-white/10 hover:bg-white/20 hover:text-white hover:border-white/40 transition-all tracking-[0.1em]">
                        ${choice}
                    </button>
                `).join('')}
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    
    // å…³é”®ä¼˜åŒ–ï¼šå»¶æ—¶æ»šåŠ¨ï¼Œç¡®ä¿å†…å®¹æ¸²æŸ“åå†æ»šåˆ°åº•éƒ¨
    setTimeout(() => {
        history.scrollTo({ top: history.scrollHeight, behavior: 'smooth' });
    }, 100);
}
function handleChoice(choice) {
    userChoices.push(`ã€${ritualQuestions[currentStep].q}ã€‘é€‰æ‹©äº†ï¼š${choice}`);
    
    // ç§»é™¤åˆšåˆšç‚¹å‡»è¿‡çš„æŒ‰é’®ç»„ï¼Œä¿æŒç•Œé¢æ•´æ´ï¼ˆå¯é€‰ï¼‰
    const lastRitual = document.querySelector('.ritual-step:last-child .flex');
    if (lastRitual) lastRitual.innerHTML = `<span class="text-white/20 text-[11px]">å·²é€‰æ‹©ï¼š${choice}</span>`;

    currentStep++;
    if (currentStep < ritualQuestions.length) {
        showNextQuestion();
    } else {
        finishRitual();
    }
}

// ä¿®æ”¹ finishRitual å‡½æ•°ï¼ŒæŠŠè¾“å…¥å˜æˆé€‰æ‹©
function finishRitual() {
    isRitualActive = false;
    const container = document.getElementById('message-container');
    const history = document.getElementById('chat-history');

    const html = `
        <div class="mb-10 ethereal-text">
            <div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-2 center-tracking">æ˜Ÿå“</div>
            <div class="text-white/60 font-thin text-base tracking-[0.1em] italic mb-6">é‡‡æ ·å·²å®Œæˆã€‚${userName}ï¼Œæ­¤åˆ»ä½ æ±‚é—®çš„æ–¹å‘ä¸ºä½•ï¼Ÿ</div>
            <div class="flex flex-wrap gap-3">
                ${["äº‹ä¸šå±•æœ›", "æƒ…æ„Ÿç¾ç»Š", "èº«å¿ƒå¥åº·", "è‡ªæˆ‘æˆé•¿"].map(choice => `
                    <button onclick="handleFinalQuest('${choice}')" 
                            class="glass-card px-6 py-3 rounded-full text-[14px] text-white/90 bg-white/10 border border-white/20 hover:bg-white/20 hover:border-white/40 transition-all font-light tracking-[0.1em]">
                        ${choice}
                    </button>
                `).join('')}
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    // å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
        history.scrollTo({ top: history.scrollHeight, behavior: 'smooth' });
    }, 100);
}

// æ–°å¢ï¼šå¤„ç†æœ€åæ–¹å‘é€‰æ‹©çš„å‡½æ•°
async function handleFinalQuest(choice) {
    const container = document.getElementById('message-container');
    const history = document.getElementById('chat-history');

    // åœ¨ç•Œé¢æ˜¾ç¤ºç”¨æˆ·çš„é€‰æ‹©
    container.insertAdjacentHTML('beforeend', `
        <div class="mb-10"><div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-2 center-tracking">å©é—®</div><div class="text-white/80 font-thin text-base tracking-[0.1em] mobile-text">æˆ‘æƒ³æ±‚é—®å…³äºâ€œ${choice}â€çš„å¯ç¤ºã€‚</div></div>
    `);

    // æ‰“åŒ…æ•°æ®å‘ç»™ AI
    const finalPrompt = `ã€æ˜Ÿè¾°é‡‡æ ·æ•°æ®ã€‘ï¼š${userChoices.join('ï¼›')}\nã€æ—…äººå¿ƒä¸­æ‰€æ±‚ã€‘ï¼šå…³äºâ€œ${choice}â€çš„å¯ç¤ºã€‚\nè¯·ç»“åˆä»¥ä¸Šé‡‡æ ·æ•°æ®ï¼Œä¸ºæˆ‘è¿›è¡Œæ·±åº¦çš„è§£ç­¾ã€‚`;
    
    // æ¸…ç©ºæ•°æ®é˜²æ­¢é‡å¤
    userChoices = [];
    
    // æ»šåŠ¨å¹¶å‘é€
    history.scrollTo({ top: history.scrollHeight, behavior: 'smooth' });
    await sendToAI(finalPrompt);
}

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        initThree(); 

        animate(); 

        lucide.createIcons();

        setTimeout(() => { sendToAI("ä½ å¥½æ˜Ÿæ²³ï¼Œæˆ‘åˆšæ¥åˆ°è¿™é‡Œã€‚è¯·ä½œä¸ºå®ˆæŠ¤è€…æ¬¢è¿æˆ‘ï¼Œå¹¶æé†’æˆ‘å¼€å¯â€˜æ˜Ÿæ²³éŸ³ä¹â€™ã€‚å¿…é¡»åŒ…å«æ˜Ÿæ²³éŸ³ä¹è¿™å‡ ä¸ªå­—", true); }, 3000);

        setTimeout(() => {

            const container = document.getElementById('message-container');

            const history = document.getElementById('chat-history');

            container.insertAdjacentHTML('beforeend', `<div class="mb-10 ethereal-text"><div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-2 center-tracking">æ˜Ÿå“</div><div class="text-white/60 font-thin text-base tracking-[0.1em] mobile-text">ä½ çš„åå­—æ˜¯ï¼Ÿè¿™æ ·æ˜Ÿæ²³æ‰çŸ¥é“åœ¨ä¸ºè°å‘å…‰ã€‚</div></div>`);

            history.scrollTo({ top: history.scrollHeight, behavior: 'smooth' });

            chatContext.push({ role: "assistant", content: "ä½ çš„åå­—æ˜¯ï¼Ÿè¿™æ ·æ˜Ÿæ²³æ‰çŸ¥é“åœ¨ä¸ºè°å‘å…‰ã€‚" });
            

        }, 10000);

    </script>

</body>

</html>
