<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leyes - Local Eyes on China</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.8s ease-out forwards; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #top-save-prompt {
            position: sticky;
            top: 0; 
            z-index: 60; 
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(-100%); 
            opacity: 0;
        }
        .show-prompt { transform: translateY(0) !important; opacity: 1 !important; }

        #chat-input-area-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 70; 
            background-color: #f8fafc; 
            padding: 16px 0; 
            box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.05); 
        }
        
        #chat-history {
            padding-bottom: 112px; 
            /* ç§»é™¤å›ºå®šé«˜åº¦ï¼Œæ”¹ç”¨ flex å¢é•¿æˆ–é…åˆ main å¸ƒå±€ */
            min-height: 400px;
        }

        /* æ ‡ç­¾æ å¸é™„æ•ˆæœä¼˜åŒ– */
        .tabs-container {
            position: sticky;
            top: 108px; /* ç´§è·Ÿåœ¨ nav åé¢ */
            background: #f8fafc;
            z-index: 45;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <div id="top-save-prompt" class="bg-blue-600 w-full shadow-lg pointer-events-none">
        <div class="max-w-4xl mx-auto px-6 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3 pointer-events-auto">
                <i data-lucide="smartphone" class="w-5 h-5 text-white"></i>
                <div>
                    <p class="font-bold text-sm text-white" data-key="save_prompt_title">Save Leyes to Desktop</p>
                    <p class="text-[10px] text-blue-200 uppercase tracking-tighter" data-key="save_prompt_subtitle">One-tap access for your trip</p>
                </div>
            </div>
            <button onclick="toggleInstructions(true)" data-key="save_prompt_button" class="pointer-events-auto bg-white text-blue-600 px-4 py-1.5 rounded-xl text-xs font-black uppercase hover:bg-blue-50 transition-colors shadow">
                How?
            </button>
        </div>
    </div>
    
    <nav class="p-6 flex justify-between items-center bg-white shadow-sm sticky top-[48px] z-50">
        <h1 class="text-3xl font-black tracking-tighter text-blue-600 italic">Leyes.</h1>
        <div class="flex items-center gap-4">
            <select id="lang-selector" onchange="setLanguage(this.value)" class="bg-white border border-slate-300 rounded-lg p-2 text-sm font-semibold">
                <option value="zh">ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="ko">í•œêµ­ì–´</option>
            </select>
            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest" data-key="nav_subtitle">æœ¬åœ°çŸ¥æƒ…è€…</span>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto">
        <div class="tabs-container flex border-b border-slate-200 px-6">
            <button id="tab-ai" onclick="switchTab('ai')" 
                    class="tab-button py-3 px-6 text-lg font-bold transition-colors border-b-4 border-blue-600 text-blue-600">
                <i data-lucide="message-square" class="w-5 h-5 inline-block mr-2"></i><span data-key="tab_ai">AI æ¨è</span>
            </button>
            <button id="tab-guides" onclick="switchTab('guides')" 
                    class="tab-button py-3 px-6 text-lg font-bold transition-colors border-b-4 border-transparent text-slate-500 hover:text-slate-700">
                <i data-lucide="map" class="w-5 h-5 inline-block mr-2"></i><span data-key="tab_guides">æ”»ç•¥åˆé›†</span>
            </button>
        </div>

        <div id="tab-content" class="px-6 py-8">
            <div id="content-ai" class="tab-content max-w-2xl mx-auto">
                <div id="welcome-message-container" class="bg-white rounded-3xl shadow-xl p-6 mb-8 border border-slate-100">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="bg-blue-600 p-2 rounded-xl">
                            <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                        </div>
                        <h3 class="text-2xl font-black" data-key="ai_chat_title">Leyes AI èŠå¤©</h3>
                    </div>
                    <p class="text-slate-600" data-key="ai_chat_greeting">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨åœ¨ä¸Šæµ·çš„ç¾é£Ÿå‘å¯¼AIã€‚</p>
                </div>

                <div id="loading-animation-container" class="hidden flex flex-col items-center justify-center py-10">
                    <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHp1eHNwZXB3Y2F5dHFqNHJhcG1xcGF5eG84ZDVnbGZ2bjY0Z3RzaSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7TKMGpxxS0D9N6uI/giphy.gif" class="w-24 h-24 rounded-full mb-4 shadow-lg">
                    <p class="text-blue-600 font-bold animate-pulse text-sm">æ­£åœ¨ä¸ºæ‚¨æœç½—ä¸Šæµ·ç¾å‘³...</p>
                </div>

                <div id="chat-history" class="overflow-y-auto no-scrollbar space-y-6">
                </div>
            </div>

            <div id="content-guides" class="tab-content hidden">
                <div id="guides-container" class="grid gap-10 max-w-4xl mx-auto py-0">
                </div>
            </div>
        </div>
    </main>
    
    <div id="chat-input-area-fixed" class="">
        <div class="max-w-5xl mx-auto px-6">
            <div class="max-w-2xl mx-auto">
                <form id="chat-form" class="flex gap-4">
                    <input type="text" id="user-input" data-key-placeholder="input_placeholder" 
                           placeholder="è¾“å…¥è¯·æ±‚..." 
                           class="flex-grow p-4 rounded-full border border-slate-300 focus:ring-2 focus:ring-blue-500 shadow-md outline-none">
                    <button type="submit" class="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-all">
                        <i data-lucide="send" class="w-6 h-6"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="instructions-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 relative">
            <button onclick="toggleInstructions(false)" class="absolute top-6 right-6 text-slate-400"><i data-lucide="x"></i></button>
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="download" class="text-blue-600 w-8 h-8"></i></div>
                <h3 class="text-2xl font-black" data-key="how_to_title">Add to Home Screen</h3>
            </div>
            <button onclick="toggleInstructions(false)" data-key="how_to_got_it" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-xl active:scale-95 transition-all">GOT IT!</button>
        </div>
    </div>

    <script>
        // === è¯­è¨€ä¸æ•°æ® (ä¿æŒä¸å˜) ===
        const translations = {
            zh: { nav_subtitle: "æœ¬åœ°çŸ¥æƒ…è€…", tab_ai: "AI æ¨è", tab_guides: "æ”»ç•¥åˆé›†", ai_chat_title: "Leyes AI èŠå¤©", ai_chat_greeting: "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨åœ¨ä¸Šæµ·çš„ç¾é£Ÿå‘å¯¼AIã€‚å‘Šè¯‰æˆ‘æ‚¨æƒ³åƒä»€ä¹ˆï¼š", input_placeholder: "åœ¨æ­¤è¾“å…¥æ‚¨çš„è¯·æ±‚ (ä¾‹å¦‚ï¼šâ€œé…’åº—é™„è¿‘çš„æœ€ä½³é¢é¦†â€)", save_prompt_title: "ä¿å­˜ Leyes åˆ°æ¡Œé¢", save_prompt_subtitle: "ä¸€é”®è®¿é—®ï¼Œè½»æ¾æ—…è¡Œ", save_prompt_button: "å¦‚ä½•æ“ä½œï¼Ÿ", how_to_title: "æ·»åŠ åˆ°ä¸»å±å¹•", how_to_got_it: "æ˜ç™½äº†ï¼" },
            en: { nav_subtitle: "Local Insider", tab_ai: "AI Recommender", tab_guides: "Curated Guides", ai_chat_title: "Leyes AI Chat", ai_chat_greeting: "Hello! I'm your local guide AI for Shanghai cuisine. Tell me what you're craving:", input_placeholder: "Type your request here (e.g., 'Best noodles near my hotel')", save_prompt_title: "Save Leyes to Desktop", save_prompt_subtitle: "One-tap access for your trip", save_prompt_button: "How?", how_to_title: "Add to Home Screen", how_to_got_it: "GOT IT!" },
            ja: { nav_subtitle: "ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼", tab_ai: "AIã®ãŠã™ã™ã‚", tab_guides: "å³é¸ã‚¬ã‚¤ãƒ‰", ai_chat_title: "Leyes AIãƒãƒ£ãƒƒãƒˆ", ai_chat_greeting: "ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯ä¸Šæµ·ã‚°ãƒ«ãƒ¡ã®ãƒ­ãƒ¼ã‚«ãƒ«AIã‚¬ã‚¤ãƒ‰ã§ã™ã€‚é£Ÿã¹ãŸã„ã‚‚ã®ã‚’æ•™ãˆã¦ãã ã•ã„ï¼š", input_placeholder: "ã“ã“ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", save_prompt_title: "Leyesã‚’ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«ä¿å­˜", save_prompt_subtitle: "ã‚¿ãƒƒãƒ—ä¸€ã¤ã§ã‚¢ã‚¯ã‚»ã‚¹", save_prompt_button: "æ–¹æ³•", how_to_title: "ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ", how_to_got_it: "äº†è§£ã—ã¾ã—ãŸï¼" },
            ko: { nav_subtitle: "í˜„ì§€ ë‚´ë¶€ì", tab_ai: "AI ì¶”ì²œ", tab_guides: "ì—„ì„  ê°€ì´ë“œ", ai_chat_title: "Leyes AI ì±„íŒ…", ai_chat_greeting: "ì•ˆë…•í•˜ì„¸ìš”! ìƒí•˜ì´ ë¯¸ì‹ ê°€ì´ë“œ AIì…ë‹ˆë‹¤. ë¨¹ê³  ì‹¶ì€ ê²ƒì„ ì•Œë ¤ì£¼ì„¸ìš”:", input_placeholder: "ì—¬ê¸°ì— ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”", save_prompt_title: "Leyesë¥¼ ë°ìŠ¤í¬í†±ì— ì €ì¥", save_prompt_subtitle: "ì›í„°ì¹˜ ì•¡ì„¸ìŠ¤", save_prompt_button: "ë°©ë²•", how_to_title: "í™ˆ í™”ë©´ì— ì¶”ê°€", how_to_got_it: "ì•Œê² ìŠµë‹ˆë‹¤ï¼" }
        };
        let currentLang = 'zh';

        const guidesData = [
            { id: 'food_noodles', name: { zh: "è€ä¸Šæµ·çš„åç¢—é¢", en: "Ten Classic Shanghai Noodles", ja: "ä¸Šæµ·ã®ä¼çµ±çš„ãªéººæ–™ç†10é¸", ko: "ìƒí•˜ì´ 10ëŒ€ ì „í†µ êµ­ìˆ˜" }, category: { zh: "æœ¬åœ°ç»å…¸", en: "Local Classics", ja: "ãƒ­ãƒ¼ã‚«ãƒ«åç‰©", ko: "í˜„ì§€ í´ë˜ì‹" }, description: { zh: "ç²¾é€‰åå®¶æœ¬åœ°äººä»å°åƒåˆ°å¤§çš„é¢é¦†ï¼Œä¸€å£å…¥é­‚ã€‚", en: "Ten noodle shops locals swear by.", ja: "åœ°å…ƒæ°‘ãŒæ„›ã™ã‚‹é¢å±‹10é¸ã€‚", ko: "í˜„ì§€ì¸ë“¤ì˜ ë§›ì§‘ 10ê³³ã€‚" }, image: "https://images.unsplash.com/photo-1547372076-4d0092306915?w=400", color: "bg-red-600", colorLight: "bg-red-100" },
            { id: 'food_cafe', name: { zh: "æ³•ç§Ÿç•Œå’–å•¡åœ°å›¾", en: "French Concession Cafe Map", ja: "ãƒ•ãƒ©ãƒ³ã‚¹ç§Ÿç•Œã‚«ãƒ•ã‚§ãƒãƒƒãƒ—", ko: "í”„ë‘ìŠ¤ ì¡°ê³„ì§€ ì¹´í˜ ì§€ë„" }, category: { zh: "å’–å•¡æŒ‡å—", en: "Cafe Guide", ja: "ã‚«ãƒ•ã‚§ã‚¬ã‚¤ãƒ‰", ko: "ì¹´í˜ ê°€ì´ë“œ" }, description: { zh: "æ¢§æ¡æ ‘ä¸‹çš„ç²¾å“å’–å•¡åº—ï¼Œäº«å—ä¼˜é›…çš„åˆåæ—¶å…‰ã€‚", en: "Boutique cafes under the parasol trees.", ja: "ãŠã—ã‚ƒã‚Œãªã‚«ãƒ•ã‚§ã§å„ªé›…ãªåˆå¾Œã‚’ã€‚", ko: "í”Œë¼íƒ€ë„ˆìŠ¤ ë‚˜ë¬´ ì•„ë˜ ë¶€í‹°í¬ ì¹´í˜ã€‚" }, image: "https://images.unsplash.com/photo-1596707325257-25e1740b2f5b?w=400", color: "bg-amber-600", colorLight: "bg-amber-100" }
        ];

        // === æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ ===

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[lang][key]) el.innerHTML = translations[lang][key];
            });
            document.querySelectorAll('[data-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-key-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });
            renderGuides();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('border-blue-600', 'text-blue-600'));
            
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('border-blue-600', 'text-blue-600');
            
            document.getElementById('chat-input-area-fixed').style.display = (tabName === 'ai' ? 'block' : 'none');
        }

        function appendMessage(text, sender, isLoading = false) {
            const chatHistory = document.getElementById('chat-history');
            const msgDiv = document.createElement('div');
            const baseClass = 'max-w-[80%] p-4 rounded-xl shadow-md animate-slide-up';
            
            if (sender === 'user') {
                msgDiv.className = `${baseClass} bg-blue-500 text-white ml-auto rounded-br-none`;
                msgDiv.textContent = text;
            } else {
                msgDiv.className = `${baseClass} bg-white text-slate-800 rounded-tl-none`;
                msgDiv.innerHTML = isLoading ? '<div class="animate-pulse">...</div>' : text;
            }

            chatHistory.appendChild(msgDiv);
            
            // ğŸŒŸ æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰å½“ç”¨æˆ·æœ¬æ¥å°±åœ¨åº•éƒ¨æ—¶æ‰æ»šåŠ¨ ğŸŒŸ
            const isScrolledToBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 100;
            if (isScrolledToBottom) {
                msgDiv.scrollIntoView({ behavior: 'smooth' });
            }
            return msgDiv;
        }

        function formatAiResponse(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            return text.replace(/(\r\n|\n\r|\n|\r)/g, '<br>');
        }

        async function streamAiResponse(userMessage) {
            const historyElement = document.getElementById('chat-history');
            const loadingAnim = document.getElementById('loading-animation-container');
            
            // 1. æ˜¾ç¤º 5 ç§’åŠ¨ç”»
            loadingAnim.classList.remove('hidden');
            let animationCleared = false;
            const animTimer = setTimeout(() => {
                loadingAnim.classList.add('hidden');
                animationCleared = true;
            }, 5000);

            let aiMessageDiv = null;
            let accumulatedText = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMessage, language: currentLang }),
                });

                if (!response.ok) throw new Error('Network error');

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    // æ”¶åˆ°æ•°æ®æµå³åˆ»åœæ­¢åŠ¨ç”»ï¼ˆå¦‚æœ 5 ç§’è¿˜æ²¡åˆ°ï¼‰
                    if (!animationCleared) {
                        clearTimeout(animTimer);
                        loadingAnim.classList.add('hidden');
                        animationCleared = true;
                    }

                    // ç¬¬ä¸€æ¬¡æ”¶åˆ°æ•°æ®æ—¶åˆ›å»ºæ¶ˆæ¯æ°”æ³¡
                    if (!aiMessageDiv) {
                        aiMessageDiv = appendMessage('', 'ai');
                    }

                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));
                            if (data.text) {
                                accumulatedText += data.text;
                                aiMessageDiv.innerHTML = formatAiResponse(accumulatedText);
                                
                                // ğŸŒŸ æ¥æ”¶æµæ—¶æ™ºèƒ½æ»šåŠ¨ ğŸŒŸ
                                const isScrolledToBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 150;
                                if (isScrolledToBottom) {
                                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'instant' });
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                appendMessage('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ã€‚', 'ai');
            } finally {
                loadingAnim.classList.add('hidden');
                document.getElementById('user-input').disabled = false;
                lucide.createIcons();
            }
        }

        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const msg = input.value.trim();
            if (msg) {
                document.getElementById('welcome-message-container').classList.add('hidden');
                appendMessage(msg, 'user');
                input.value = '';
                input.disabled = true;
                streamAiResponse(msg);
            }
        });

        function renderGuides() {
            const container = document.getElementById('guides-container');
            container.innerHTML = guidesData.map(guide => `
                <div class="bg-white rounded-3xl shadow-lg p-6 flex flex-col md:flex-row gap-6 border border-slate-100">
                    <img src="${guide.image}" class="w-full md:w-48 h-48 object-cover rounded-2xl flex-shrink-0">
                    <div>
                        <span class="text-xs font-bold ${guide.color.replace('bg-', 'text-')} px-3 py-1 rounded-full ${guide.colorLight}">${guide.category[currentLang]}</span>
                        <h4 class="text-2xl font-black mt-2">${guide.name[currentLang]}</h4>
                        <p class="text-slate-600 mt-1">${guide.description[currentLang]}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function toggleInstructions(show) {
            document.getElementById('instructions-modal').classList.toggle('hidden', !show);
        }

        document.addEventListener('DOMContentLoaded', () => {
            setLanguage('zh');
            switchTab('ai');
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    document.getElementById('top-save-prompt').classList.add('show-prompt');
                }
            }, 2000);
        });
    </script>
</body>
</html>
