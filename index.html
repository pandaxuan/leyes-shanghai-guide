<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Leyes - 凝望星河</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>

    

    <style>

        body { margin: 0; background: #000205; color: white; overflow: hidden; font-family: "PingFang SC", "STHeiti", "Microsoft YaHei", sans-serif; -webkit-tap-highlight-color: transparent; }

        #canvas-container { position: fixed; inset: 0; z-index: 0; }

        

        #fixed-nav { position: fixed; top: 0; left: 0; right: 0; z-index: 50; pointer-events: none; }

        #main-ui { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; pointer-events: none; }



        #chat-history { 

            flex-grow: 1;

            margin-top: 80px; 

            margin-bottom: 110px; 

            overflow-y: auto; 

            padding: 0 1.5rem;

            pointer-events: auto;

            mask-image: linear-gradient(to bottom, transparent, black 8%, black 92%, transparent);

            -webkit-mask-image: linear-gradient(to bottom, transparent, black 8%, black 92%, transparent);

            scroll-behavior: smooth;

        }



        .glass-card {

            background: rgba(255, 255, 255, 0.02);

            backdrop-filter: blur(25px);

            -webkit-backdrop-filter: blur(25px);

            border: 1px solid rgba(255, 255, 255, 0.08);

            box-shadow: 0 0 50px rgba(0, 0, 0, 0.6);

            pointer-events: auto;

        }



        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .music-spinning { animation: rotate-slow 4s linear infinite; }



        @keyframes ethereal-fade {

            from { opacity: 0; filter: blur(12px); transform: translateY(15px) scale(1.05); }

            to { opacity: 1; filter: blur(0); transform: translateY(0) scale(1); }

        }

        .ethereal-text { animation: ethereal-fade 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .center-tracking { padding-left: 0.8em; }



        @media (max-width: 640px) {

            #chat-history { margin-top: 70px; margin-bottom: 90px; }

            .mobile-title { font-size: 2.2rem !important; letter-spacing: 0.6em !important; padding-left: 0.6em !important; }

            .mobile-subtitle { font-size: 9px !important; letter-spacing: 0.3em !important; white-space: nowrap; }

            .mobile-text { font-size: 1rem !important; font-weight: 300 !important; color: rgba(255,255,255,0.9) !important; }

        }

        /* 保持你原有的 CSS，在最后添加这些 */
@keyframes lavaMove {
    0% { transform: translate(-10%, -10%) scale(1); }
    100% { transform: translate(10%, 10%) scale(1.1); }
}

@keyframes sparkle {
    0% { opacity: 0.1; transform: scale(0.8); }
    100% { opacity: 1; transform: scale(1.2); }
}

.lava-container {
    mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
    -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
    filter: contrast(140%) brightness(110%);
}

    </style>

</head>

<body>



    <div id="canvas-container"></div>

    <audio id="bgm" loop src="bgm.mp3"></audio>



    <div id="fixed-nav">

        <nav class="p-6 sm:p-10 flex justify-between items-center pointer-events-auto">

            <h1 class="text-lg sm:text-xl font-thin tracking-[0.4em] text-white/70 uppercase italic">Leyes.</h1>

            <div class="flex items-center gap-3 sm:gap-6">

                <button id="music-btn" onclick="toggleMusic()" class="glass-card flex items-center gap-2 text-white/60 px-4 py-2.5 rounded-full border border-white/5 transition-all">

                    <div id="music-icon-container"><i data-lucide="music" class="w-3 h-3 sm:w-4 sm:h-4"></i></div>

                    <span class="text-[9px] sm:text-[10px] tracking-[0.3em] uppercase">星河音乐</span>

                </button>

                <button onclick="askTheUniverse()" class="glass-card text-white/80 px-6 sm:px-10 py-2.5 sm:py-3 rounded-full text-[10px] tracking-[0.5em] border border-white/10 hover:bg-white/10 transition-all duration-1000">询问星河</button>

            </div>

        </nav>

    </div>



    <div id="main-ui">

        <div id="chat-history" class="no-scrollbar max-w-2xl mx-auto w-full">

            <div id="header-section" class="text-center pt-24 pb-20 sm:pt-32 sm:pb-32 ethereal-text">

                <h2 class="text-3xl sm:text-5xl font-thin tracking-[0.8em] sm:tracking-[1.2em] mb-8 text-white/80 mobile-title center-tracking">凝望星河</h2>

                <div class="flex justify-center items-center gap-3 px-4">

                    <div class="h-[1px] flex-grow max-w-[40px] bg-white/10"></div>

                    <p class="text-white/40 tracking-[0.4em] text-[10px] sm:text-xs uppercase mobile-subtitle">时间揉碎在璀璨星河，而我一直在你身边</p>

                    <div class="h-[1px] flex-grow max-w-[40px] bg-white/10"></div>

                </div>

            </div>

            <div id="message-container" class="space-y-12 pb-20"></div>

        </div>

    </div>



    <div class="fixed bottom-0 left-0 right-0 p-8 sm:p-16 z-50">

        <div class="max-w-xl mx-auto flex gap-4 items-center glass-card p-3 sm:p-3 rounded-full border-white/10">

            <input type="text" id="user-input" class="flex-grow bg-transparent text-white px-5 sm:px-8 py-2 outline-none placeholder:text-white/20 text-sm tracking-[0.2em] font-light" placeholder="把未说完的话，写给星河...">

            <button id="send-btn" class="text-white/40 hover:text-white transition-all duration-700 p-1">

                <i data-lucide="arrow-up-circle" class="w-8 h-8 stroke-[1px]"></i>

            </button>

        </div>

    </div>



    <div id="fortune-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-black/95 backdrop-blur-2xl">

        <div class="max-w-md w-full text-center ethereal-text">

            <div class="text-white/20 mb-10 tracking-[1.5em] text-[10px] uppercase font-thin">星河的启示</div>

            <p id="fortune-text" class="text-xl font-thin leading-loose text-white/90 mb-16 tracking-[0.4em] px-4 mobile-text"></p>

            <button onclick="closeFortune()" class="text-white/30 hover:text-white text-[11px] tracking-[0.6em] uppercase transition-all duration-1000">[ 闭上双眼 ]</button>

        </div>

    </div>



    <script>

        const BACKEND_URL = 'https://leyes-shanghai-guide.onrender.com';

        const bgm = document.getElementById('bgm');

        const musicBtn = document.getElementById('music-btn');

        const musicIconContainer = document.getElementById('music-icon-container');

        let isPlaying = false;



        // --- 核心变量：上下文记忆与自动计时器 ---

        let chatContext = []; 

        let idleTimer = null; 

        let autoMessageCount = 0; // 新增：记录主动提问次数
        let hasName = false; // 新增：是否已获得名字
        let userName = "";   // 新增：存储用户名字

        const MAX_AUTO_MESSAGES = 10; // 新增：最大限制10次

        const IDLE_TIME = 60000; 



        function toggleMusic() {

            if (isPlaying) { bgm.pause(); musicIconContainer.classList.remove('music-spinning'); musicBtn.style.opacity = "0.4"; }

            else { bgm.play().catch(e => {}); musicIconContainer.classList.add('music-spinning'); musicBtn.style.opacity = "1"; }

            isPlaying = !isPlaying;

        }



        // 重置闲聊计时逻辑

        function resetIdleTimer() {

            if (idleTimer) clearTimeout(idleTimer);
            // 只有在获得名字后，才开启闲聊倒计时
            if (!hasName || autoMessageCount >= MAX_AUTO_MESSAGES) return;

            if (autoMessageCount >= MAX_AUTO_MESSAGES) return;

            idleTimer = setTimeout(() => {

                const topics = [

            "感叹当下的寂静与星光",

            "探讨旅人沉默背后的思绪",

            "引用一段关于宇宙、时间或孤独的空灵哲思",

            "询问旅人此刻是否在听那远古的星声",

            "观察星云的流动，并分享一种转瞬即逝的美感",

            "探讨记忆与光年的关系",

            "温柔地提醒旅人，无论多久，星河都会在此守候"

                ];

                const randomTopic = topics[Math.floor(Math.random() * topics.length)];

                const idlePrompt = `旅人已沉思许久。请作为星河守护者，基于“${randomTopic}”这个主题主动发起一段对话。要求：语言极度优美、空灵，不要重复之前说过的话，字数控制在30字左右。`;

                autoMessageCount++; // 增加计数

                sendToAI(idlePrompt, true);

            }, IDLE_TIME);

        }



        async function handleStream(res, element) {

            const reader = res.body.getReader();

            const decoder = new TextDecoder();

            const history = document.getElementById('chat-history');

            let fullContent = ""; 

            element.innerText = "";

            

            while (true) {

                const { done, value } = await reader.read();

                if (done) break;

                const chunk = decoder.decode(value);

                const lines = chunk.split('\n');

                for (const line of lines) {

                    if (line.startsWith('data: ')) {

                        try {

                            const data = JSON.parse(line.substring(6));

                            if (data.text) {

                                element.innerText += data.text;

                                fullContent += data.text;

                                history.scrollTo({ top: history.scrollHeight, behavior: 'auto' });

                            }

                        } catch (e) {}

                    }

                }

            }

            return fullContent;

        }



        async function sendToAI(userMessage, isAuto = false) {
            const container = document.getElementById('message-container');
            const history = document.getElementById('chat-history');
            const uniqueId = 'ai-' + Date.now();

            // 如果不是自动消息，就在 UI 显示用户说的话
            if (!isAuto) {
                // 这里已经在 handleSend 里处理了，不用重复
            }

            container.insertAdjacentHTML('beforeend', `
                <div class="mb-10 ethereal-text">
                    <div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-2 center-tracking">星响</div>
                    <div id="${uniqueId}" class="text-white/60 font-thin text-base tracking-[0.1em] italic mobile-text">聆听群星...</div>
                </div>
            `);
            
            const aiDisplay = document.getElementById(uniqueId);
            history.scrollTo({ top: history.scrollHeight, behavior: 'smooth' });

            try {
                // 1. 自动提取名字逻辑
                if (!hasName && chatContext.length > 0) {
                    const lastMsg = chatContext[chatContext.length - 1].content;
                    if (lastMsg.includes("你的名字是？")) {
                        userName = userMessage.replace(/我叫|我是|叫我|名字是|。/g, "").trim();
                        hasName = true;
                    }
                }

                // 2. 构造强制指令
                let processedMessage = userMessage;
                let systemPrompt = "你是一个空灵的星河守护者。Leyes是你的名字。";

                if (hasName) {
                    // 【核心改动】：在每一条发给 AI 的用户消息后面，强制附带一个隐形指令
                    processedMessage = `${userMessage} （注意：我是${userName}，请在回复中自然地称呼我的名字，并确认你已记住。）`;
                    systemPrompt += `当前旅人名字叫“${userName}”。你必须在每一句回复中都包含这个名字。`;
                }

                const res = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: processedMessage, // 发送带有“名字提醒”的消息
                        messages: [
                            { role: "system", content: systemPrompt },
                            ...chatContext,
                            { role: "user", content: processedMessage }
                        ],
                        language: 'zh' 
                    }),
                });

                const finalResponse = await handleStream(res, aiDisplay);
                aiDisplay.classList.remove('italic');

                // 3. 更新记忆（保存干净的对话，不带隐形指令）
                chatContext.push({role: "user", content: userMessage});
                chatContext.push({role: "assistant", content: finalResponse});
                if (chatContext.length > 20) chatContext = chatContext.slice(-20);

                resetIdleTimer();
            } catch (e) {
                aiDisplay.innerText = "信号在光年外迷失了...";
            }
        }


        const handleSend = async () => {

            const input = document.getElementById('user-input');

            const message = input.value.trim();

            if (!message) return;



            if (idleTimer) clearTimeout(idleTimer);



            const container = document.getElementById('message-container');

            container.insertAdjacentHTML('beforeend', `

                <div class="mb-10">

                    <div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-2 center-tracking">叩问</div>

                    <div class="text-white/80 font-thin text-base tracking-[0.1em] mobile-text">${message}</div>

                </div>

            `);

            

            input.value = "";

            await sendToAI(message);

        };

// --- 修复：添加缺失的银色熔岩背景函数 ---
    function applyLavaEffect() {
        const modal = document.getElementById('fortune-modal');
        if (!modal) return;
        let container = modal.querySelector('.lava-container');
        if (container) container.remove(); 
        container = document.createElement('div');
        container.className = 'lava-container';
        container.style.cssText = `position: absolute; inset: 0; z-index: -1; background: #000; overflow: hidden;`;
        for (let i = 0; i < 6; i++) {
            const blob = document.createElement('div');
            blob.style.cssText = `
                position: absolute; width: ${Math.random() * 60 + 40}vw; height: ${Math.random() * 60 + 40}vw;
                background: radial-gradient(circle, rgba(200,200,200,0.15) 0%, rgba(255,255,255,0.03) 50%, transparent 100%);
                left: ${Math.random() * 100 - 50}%; top: ${Math.random() * 100 - 50}%;
                filter: blur(80px); animation: lavaMove ${20 + i * 5}s infinite alternate ease-in-out;
            `;
            container.appendChild(blob);
        }
        for (let i = 0; i < 35; i++) {
            const sparkle = document.createElement('div');
            sparkle.style.cssText = `
                position: absolute; width: 2px; height: 2px; background: white;
                left: ${Math.random() * 100}%; top: ${Math.random() * 100}%;
                box-shadow: 0 0 10px 1px white; opacity: ${Math.random()};
                animation: sparkle ${2 + Math.random() * 3}s infinite alternate;
            `;
            container.appendChild(sparkle);
        }
        modal.insertBefore(container, modal.firstChild);
    }

        async function askTheUniverse() {
            applyLavaEffect(); // 这一行触发银色熔岩背景

            if (idleTimer) clearTimeout(idleTimer);

            const modal = document.getElementById('fortune-modal');

            const txt = document.getElementById('fortune-text');

            modal.classList.remove('hidden');

            txt.innerText = "正在拨开星云...";

            try {

                const res = await fetch(`${BACKEND_URL}/api/chat`, {

                    method: 'POST',

                    headers: { 'Content-Type': 'application/json' },

                    body: JSON.stringify({ message: "请作为这片星河的守护者，为我写一首大约十行的启示之诗。风格要空灵、深邃、带有哲思，不需要标题。", language: 'zh' }),

                });

                await handleStream(res, txt);

                resetIdleTimer();

            } catch (e) { txt.innerText = "星尘漫过，请稍后再试。"; }

        }



        function closeFortune() { 

            document.getElementById('fortune-modal').classList.add('hidden'); 

            resetIdleTimer();

        }



        document.getElementById('user-input').addEventListener('input', () => {

            if (idleTimer) clearTimeout(idleTimer);

        });



        document.getElementById('send-btn').onclick = handleSend;

        document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });



       // --- 增强：高级视觉背景渲染 (Three.js) ---
    let scene, camera, renderer, particles, mouse = new THREE.Vector2(), targetMouse = new THREE.Vector2();
    const PARTICLE_COUNT = window.innerWidth < 640 ? 4500 : 12000;


        function createGlowTexture() {

            const canvas = document.createElement('canvas');

            canvas.width = 64; canvas.height = 64;

            const ctx = canvas.getContext('2d');

            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);

            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');

            gradient.addColorStop(0.3, 'rgba(255, 255, 255, 0.7)');

            gradient.addColorStop(0.6, 'rgba(255, 255, 255, 0.2)');

            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            ctx.fillStyle = gradient; ctx.fillRect(0, 0, 64, 64);

            return new THREE.CanvasTexture(canvas);

        }



        function initThree() {

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);

            camera.position.z = 7;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });

            renderer.setSize(window.innerWidth, window.innerHeight);

            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const geo = new THREE.BufferGeometry();

            const pos = new Float32Array(PARTICLE_COUNT * 3);

            const colors = new Float32Array(PARTICLE_COUNT * 3);

            const originalColors = new Float32Array(PARTICLE_COUNT * 3);

            const palette = [new THREE.Color('#ffffff'), new THREE.Color('#ffffff'), new THREE.Color('#bae6fd'), new THREE.Color('#e9d5ff')];

            for (let i = 0; i < PARTICLE_COUNT; i++) {

                pos[i*3] = (Math.random() - 0.5) * 20; pos[i*3+1] = (Math.random() - 0.5) * 20; pos[i*3+2] = (Math.random() - 0.5) * 10;

                const col = palette[Math.floor(Math.random() * palette.length)];

                colors[i*3] = originalColors[i*3] = col.r; colors[i*3+1] = originalColors[i*3+1] = col.g; colors[i*3+2] = originalColors[i*3+2] = col.b;

            }

            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));

            geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            geo.setAttribute('originalColor', new THREE.BufferAttribute(originalColors, 3));

            // --- 视觉优化点 1：粒子变粗 (size: 0.15) ---
        const mat = new THREE.PointsMaterial({ 
            size: 0.15, 
            map: createGlowTexture(), 
            vertexColors: true, 
            transparent: true, 
            opacity: 0.7, 
            blending: THREE.AdditiveBlending, 
            depthWrite: false, 
            sizeAttenuation: true 
        });
            particles = new THREE.Points(geo, mat);

            scene.add(particles);

            const handleMove = (x, y) => { targetMouse.x = (x / window.innerWidth) * 2 - 1; targetMouse.y = -(y / window.innerHeight) * 2 + 1; };

            window.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY));

            window.addEventListener('touchmove', (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY), { passive: true });

        }



        function animate() {

            requestAnimationFrame(animate);

            // --- 视觉优化点 2：胶质感平滑度 (lerp: 0.05) ---
        mouse.lerp(targetMouse, 0.05);

            const positions = particles.geometry.attributes.position.array;

            const colors = particles.geometry.attributes.color.array;

            const originals = particles.geometry.attributes.originalColor.array;

            const time = Date.now() * 0.0003;

            for (let i = 0; i < PARTICLE_COUNT; i++) {

                const i3 = i * 3;

                positions[i3] += Math.sin(time + i) * 0.0004; positions[i3+1] += Math.cos(time + i) * 0.0004;

                const flicker = 0.8 + Math.sin(time * 5 + i) * 0.2;

                colors[i3] = originals[i3] * flicker; colors[i3+1] = originals[i3+1] * flicker; colors[i3+2] = originals[i3+2] * flicker;

                // --- 视觉优化点 3：胶质吸附计算 ---
            const dx = positions[i3] - (mouse.x * 6); const dy = positions[i3+1] - (mouse.y * 4);

                const distSq = dx*dx + dy*dy;

                if (distSq < 3) { 
                const dist = Math.sqrt(distSq); 
                const force = (1.5 - dist) / 1.5; 
                // 这里的系数 0.025 提供了一种缓慢、粘稠的拉扯感
                positions[i3] += dx * force * 0.025; 
                positions[i3+1] += dy * force * 0.025; 
            }

            }

            particles.geometry.attributes.position.needsUpdate = true;

            particles.geometry.attributes.color.needsUpdate = true;

            particles.rotation.y += 0.0002;

            renderer.render(scene, camera);

        }



        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });



        // --- 初始化执行 ---

        initThree(); 

        animate(); 

        lucide.createIcons();



        // 页面进入3秒后发起第一次招呼

        setTimeout(() => {

            sendToAI("你好星河，我刚来到这里。请作为守护者欢迎我，并提醒我开启‘星河音乐’。必须包含星河音乐这几个字", true);

        }, 3000);



        // 10秒后直接在界面显示询问
        setTimeout(() => {
            const container = document.getElementById('message-container');
            const history = document.getElementById('chat-history');
            
            container.insertAdjacentHTML('beforeend', `
                <div class="mb-10 ethereal-text">
                    <div class="text-white/20 text-[10px] tracking-[0.4em] uppercase mb-2 center-tracking">星响</div>
                    <div class="text-white/60 font-thin text-base tracking-[0.1em] mobile-text">你的名字是？这样星河才知道在为谁发光。</div>
                </div>
            `);
            
            history.scrollTo({ top: history.scrollHeight, behavior: 'smooth' });

            // 【关键】确保对话历史中有这一句，sendToAI 才能准确判定用户下一句是在回答名字
            chatContext.push({ role: "assistant", content: "你的名字是？这样星河才知道在为谁发光。" });
        }, 10000);

    </script>

</body>

</html>
