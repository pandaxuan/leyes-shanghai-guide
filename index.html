<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leyes - Local Eyes on China</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* CSS åŠ¨ç”»å’Œæ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰*/
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.8s ease-out forwards; }

        /* éšè—æ»šåŠ¨æ¡ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* é¡¶éƒ¨ Banner æ ·å¼ */
        #top-save-prompt {
            position: sticky;
            top: 0; 
            z-index: 60; 
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(-100%); 
            opacity: 0;
        }
        .show-prompt {
            transform: translateY(0) !important;
            opacity: 1 !important;
        }

        /* æ ¸å¿ƒä¿®æ”¹ 1ï¼šå›ºå®šè¾“å…¥åŒºåŸŸåœ¨åº•éƒ¨ */
        #chat-input-area-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 70; 
            background-color: #f8fafc; 
            padding: 16px 0; 
            box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.05); 
        }
        
        /* æ ¸å¿ƒä¿®æ”¹ 2ï¼šç»™èŠå¤©è®°å½•æ·»åŠ åº•éƒ¨å¡«å……ä»¥é¿å…é®æŒ¡ */
        #chat-history {
            padding-bottom: 112px; 
            height: 400px; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <div id="top-save-prompt" class="bg-blue-600 w-full shadow-lg pointer-events-none">
        <div class="max-w-4xl mx-auto px-6 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3 pointer-events-auto">
                <i data-lucide="smartphone" class="w-5 h-5 text-white"></i>
                <div>
                    <p class="font-bold text-sm text-white" data-key="save_prompt_title">Save Leyes to Desktop</p>
                    <p class="text-[10px] text-blue-200 uppercase tracking-tighter" data-key="save_prompt_subtitle">One-tap access for your trip</p>
                </div>
            </div>
            <button onclick="toggleInstructions(true)" data-key="save_prompt_button" class="pointer-events-auto bg-white text-blue-600 px-4 py-1.5 rounded-xl text-xs font-black uppercase hover:bg-blue-50 transition-colors shadow">
                How?
            </button>
        </div>
    </div>
    
    <nav class="p-6 flex justify-between items-center bg-white shadow-sm sticky top-[48px] z-50">
        <h1 class="text-3xl font-black tracking-tighter text-blue-600 italic">Leyes.</h1>
        <div class="flex items-center gap-4">
            <select id="lang-selector" onchange="setLanguage(this.value)" class="bg-white border border-slate-300 rounded-lg p-2 text-sm font-semibold">
                <option value="zh">ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="ko">í•œêµ­ì–´</option>
            </select>
            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest" data-key="nav_subtitle">æœ¬åœ°çŸ¥æƒ…è€…</span>
        </div>
    </nav>

    <header class="px-6 pt-12 text-center max-w-3xl mx-auto">
        <h2 class="text-4xl font-extrabold leading-tight tracking-tight" data-key="header_title_1">
            ä¸Šæµ·ç¾é£ŸæŒ‡å— <br/>
            <span class="text-blue-600 underline decoration-wavy decoration-blue-200" data-key="header_title_2">é—®é—®æœ¬åœ°AIã€‚</span>
        </h2>
        <p class="text-lg text-slate-600 mt-2" data-key="header_subtitle">è·å–ä¸ªæ€§åŒ–æ¨èæˆ–æµè§ˆæˆ‘ä»¬çš„ç²¾é€‰åˆé›†ã€‚</p>
    </header>

    <main class="max-w-5xl mx-auto pt-8">
        <div class="flex border-b border-slate-200 px-6 sticky top-[158px] bg-slate-50 z-40">
            <button id="tab-ai" onclick="switchTab('ai')" 
                    class="tab-button py-3 px-6 text-lg font-bold transition-colors border-b-4 border-blue-600 text-blue-600">
                <i data-lucide="message-square" class="w-5 h-5 inline-block mr-2"></i><span data-key="tab_ai">AI æ¨è</span>
            </button>
            <button id="tab-guides" onclick="switchTab('guides')" 
                    class="tab-button py-3 px-6 text-lg font-bold transition-colors border-b-4 border-transparent text-slate-500 hover:text-slate-700">
                <i data-lucide="map" class="w-5 h-5 inline-block mr-2"></i><span data-key="tab_guides">æ”»ç•¥åˆé›†</span>
            </button>
        </div>

        <div id="tab-content" class="px-6 py-8">
            
            <div id="content-ai" class="tab-content max-w-2xl mx-auto">
                
                <div id="welcome-message-container" class="bg-white rounded-3xl shadow-xl p-6 mb-8 border border-slate-100">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="bg-blue-600 p-2 rounded-xl">
                            <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                        </div>
                        <h3 class="text-2xl font-black" data-key="ai_chat_title">Leyes AI èŠå¤©</h3>
                    </div>
                    <p class="text-slate-600" data-key="ai_chat_greeting">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨åœ¨ä¸Šæµ·çš„ç¾é£Ÿå‘å¯¼AIã€‚å‘Šè¯‰æˆ‘æ‚¨æƒ³åƒä»€ä¹ˆï¼š</p>
                    <ul class="text-sm text-slate-500 list-disc list-inside mt-2 space-y-1">
                        <li data-key="ai_chat_tip_1">"æˆ‘æƒ³åœ¨å¤–æ»©é™„è¿‘æ‰¾ä¾¿å®œçš„è¡—å¤´å°åƒã€‚"</li>
                        <li data-key="ai_chat_tip_2">"æ¨èä¸€ä¸ªæ³•ç§Ÿç•Œæµªæ¼«çš„æ™šé¤åœ°ç‚¹ã€‚"</li>
                        <li data-key="ai_chat_tip_3">"å“ªé‡Œå¯ä»¥æ‰¾åˆ°æœ€å¥½åƒçš„å°ç¬¼åŒ…ï¼Ÿ"</li>
                    </ul>
                </div>
                
                <div id="chat-history" class="h-[400px] overflow-y-auto no-scrollbar space-y-6">
                </div>
            </div>

            <div id="content-guides" class="tab-content hidden">
                <div id="guides-container" class="grid gap-10 max-w-4xl mx-auto py-0">
                </div>
            </div>
        </div>
    </main>
    
    <div id="chat-input-area-fixed" class="hidden">
        <div class="max-w-5xl mx-auto px-6">
            <div class="max-w-2xl mx-auto">
                <form id="chat-form" class="flex gap-4">
                    <input type="text" id="user-input" data-key-placeholder="input_placeholder" 
                           placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„è¯·æ±‚ (ä¾‹å¦‚ï¼šâ€œé…’åº—é™„è¿‘çš„æœ€ä½³é¢é¦†â€)" 
                           class="flex-grow p-4 rounded-full border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-md" required>
                    <button type="submit" class="bg-blue-600 text-white p-4 rounded-full font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all">
                        <i data-lucide="send" class="w-6 h-6"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="instructions-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 relative">
            <button onclick="toggleInstructions(false)" class="absolute top-6 right-6 text-slate-400">
                <i data-lucide="x"></i>
            </button>
            
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="download" class="text-blue-600 w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-black" data-key="how_to_title">Add to Home Screen</h3>
                <p class="text-slate-500 text-sm mt-2" data-key="how_to_subtitle">Keep your local guide handy.</p>
            </div>
            
            <div class="space-y-6 mb-8">
                <div class="flex gap-4 items-start">
                    <div class="bg-slate-900 text-white w-6 h-6 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold">1</div>
                    <p class="text-slate-600 text-sm" data-key="how_to_step_1">Tap the <span class='font-bold text-slate-900 underline italic'>Share button</span> (iOS) or the <span class='font-bold text-slate-900 underline'>Menu icon</span> (Android)ã€‚</p>
                </div>
                <div class="flex gap-4 items-start">
                    <div class="bg-slate-900 text-white w-6 h-6 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold">2</div>
                    <p class="text-slate-600 text-sm" data-key="how_to_step_2">Select <span class='font-bold text-slate-900 italic'>"Add to Home Screen"</span> from the optionsã€‚</p>
                </div>
            </div>

            <button onclick="toggleInstructions(false)" data-key="how_to_got_it" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-xl shadow-blue-200 active:scale-95 transition-all">
                GOT IT!
            </button>
        </div>
    </div>

    <script>
        // === è¯­è¨€æ•°æ®å¯¹è±¡ (i18n) ===
        const translations = {
            zh: {
                nav_subtitle: "æœ¬åœ°çŸ¥æƒ…è€…",
                header_title_1: "ä¸Šæµ·ç¾é£ŸæŒ‡å—",
                header_title_2: "é—®é—®æœ¬åœ°AIã€‚",
                header_subtitle: "è·å–ä¸ªæ€§åŒ–æ¨èæˆ–æµè§ˆæˆ‘ä»¬çš„ç²¾é€‰åˆé›†ã€‚",
                tab_ai: "AI æ¨è",
                tab_guides: "æ”»ç•¥åˆé›†",
                ai_chat_title: "Leyes AI èŠå¤©",
                ai_chat_greeting: "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨åœ¨ä¸Šæµ·çš„ç¾é£Ÿå‘å¯¼AIã€‚å‘Šè¯‰æˆ‘æ‚¨æƒ³åƒä»€ä¹ˆï¼š",
                ai_chat_tip_1: "â€œæˆ‘æƒ³åœ¨å¤–æ»©é™„è¿‘æ‰¾ä¾¿å®œçš„è¡—å¤´å°åƒã€‚â€",
                ai_chat_tip_2: "â€œæ¨èä¸€ä¸ªæ³•ç§Ÿç•Œæµªæ¼«çš„æ™šé¤åœ°ç‚¹ã€‚â€",
                ai_chat_tip_3: "â€œå“ªé‡Œå¯ä»¥æ‰¾åˆ°æœ€å¥½åƒçš„å°ç¬¼åŒ…ï¼Ÿâ€",
                input_placeholder: "åœ¨æ­¤è¾“å…¥æ‚¨çš„è¯·æ±‚ (ä¾‹å¦‚ï¼šâ€œé…’åº—é™„è¿‘çš„æœ€ä½³é¢é¦†â€)",
                save_prompt_title: "ä¿å­˜ Leyes åˆ°æ¡Œé¢",
                save_prompt_subtitle: "ä¸€é”®è®¿é—®ï¼Œè½»æ¾æ—…è¡Œ",
                save_prompt_button: "å¦‚ä½•æ“ä½œï¼Ÿ",
                how_to_title: "æ·»åŠ åˆ°ä¸»å±å¹•",
                how_to_subtitle: "è®©æ‚¨çš„æœ¬åœ°å‘å¯¼éšæ—¶å¯ç”¨ã€‚",
                how_to_step_1: "ç‚¹å‡» <span class='font-bold text-slate-900 underline italic'>åˆ†äº«æŒ‰é’®</span> (iOS) æˆ– <span class='font-bold text-slate-900 underline'>èœå•å›¾æ ‡</span> (Android)ã€‚",
                how_to_step_2: "ä»é€‰é¡¹ä¸­é€‰æ‹© <span class='font-bold text-slate-900 italic'>â€œæ·»åŠ åˆ°ä¸»å±å¹•â€</span>ã€‚",
                how_to_got_it: "æ˜ç™½äº†ï¼"
            },
            en: {
                nav_subtitle: "Local Insider",
                header_title_1: "Shanghai Food Guide",
                header_title_2: "Just ask the Local AI.",
                header_subtitle: "Get personalized recommendations or browse our curated collections.",
                tab_ai: "AI Recommender",
                tab_guides: "Curated Guides",
                ai_chat_title: "Leyes AI Chat",
                ai_chat_greeting: "Hello! I'm your local guide AI for Shanghai cuisine. Tell me what you're craving:",
                ai_chat_tip_1: "\"I want cheap street food near the Bund.\"",
                ai_chat_tip_2: "\"Recommend a romantic dinner place in the French Concession.\"",
                ai_chat_tip_3: "\"Where can I find the best Xiaolongbao?\"",
                input_placeholder: "Type your request here (e.g., 'Best noodles near my hotel')",
                save_prompt_title: "Save Leyes to Desktop",
                save_prompt_subtitle: "One-tap access for your trip",
                save_prompt_button: "How?",
                how_to_title: "Add to Home Screen",
                how_to_subtitle: "Keep your local guide handy.",
                how_to_step_1: "Tap the <span class='font-bold text-slate-900 underline italic'>Share button</span> (iOS) or the <span class='font-bold text-slate-900 underline'>Menu icon</span> (Android).",
                how_to_step_2: "Select <span class='font-bold text-slate-900 italic'>\"Add to Home Screen\"</span> from the options.",
                how_to_got_it: "GOT IT!"
            },
            ja: {
                nav_subtitle: "ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼",
                header_title_1: "ä¸Šæµ·ã‚°ãƒ«ãƒ¡ã‚¬ã‚¤ãƒ‰",
                header_title_2: "AIã«å°‹ã­ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
                header_subtitle: "ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãŠã™ã™ã‚ã‚’å–å¾—ã™ã‚‹ã‹ã€å³é¸ã•ã‚ŒãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–²è¦§ã—ã¦ãã ã•ã„ã€‚",
                tab_ai: "AIã®ãŠã™ã™ã‚",
                tab_guides: "å³é¸ã‚¬ã‚¤ãƒ‰",
                ai_chat_title: "Leyes AIãƒãƒ£ãƒƒãƒˆ",
                ai_chat_greeting: "ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯ä¸Šæµ·ã‚°ãƒ«ãƒ¡ã®ãƒ­ãƒ¼ã‚«ãƒ«AIã‚¬ã‚¤ãƒ‰ã§ã™ã€‚é£Ÿã¹ãŸã„ã‚‚ã®ã‚’æ•™ãˆã¦ãã ã•ã„ï¼š",
                ai_chat_tip_1: "ã€Œãƒãƒ³ãƒ‰è¿‘ãã§å®‰ã„ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ•ãƒ¼ãƒ‰ãŒæ¬²ã—ã„ã€‚ã€",
                ai_chat_tip_2: "ã€Œãƒ•ãƒ©ãƒ³ã‚¹ç§Ÿç•Œã®ãƒ­ãƒãƒ³ãƒãƒƒã‚¯ãªãƒ‡ã‚£ãƒŠãƒ¼å ´æ‰€ã‚’æ•™ãˆã¦ã€‚ã€",
                ai_chat_tip_3: "ã€Œæœ€é«˜ã®å°ç± åŒ…ã¯ã©ã“ã§é£Ÿã¹ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿã€",
                input_placeholder: "ã“ã“ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œãƒ›ãƒ†ãƒ«è¿‘ãã®ãƒ™ã‚¹ãƒˆãªéººå±‹ã€ï¼‰",
                save_prompt_title: "Leyesã‚’ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«ä¿å­˜",
                save_prompt_subtitle: "ã‚¿ãƒƒãƒ—ä¸€ã¤ã§ã‚¢ã‚¯ã‚»ã‚¹ã€æ—…ã‚’ç°¡å˜ã«",
                save_prompt_button: "æ–¹æ³•",
                how_to_title: "ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ",
                how_to_subtitle: "ãƒ­ãƒ¼ã‚«ãƒ«ã‚¬ã‚¤ãƒ‰ã‚’æ‰‹å…ƒã«ç½®ã„ã¦ãŠãã¾ã—ã‚‡ã†ã€‚",
                how_to_step_1: " <span class='font-bold text-slate-900 underline italic'>å…±æœ‰ãƒœã‚¿ãƒ³</span> (iOS) ã¾ãŸã¯ <span class='font-bold text-slate-900 underline'>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³</span> (Android) ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™ã€‚",
                how_to_step_2: "ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰ <span class='font-bold text-slate-900 italic'>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</span> ã‚’é¸æŠã—ã¾ã™ã€‚",
                how_to_got_it: "äº†è§£ã—ã¾ã—ãŸï¼"
            },
            ko: {
                nav_subtitle: "í˜„ì§€ ë‚´ë¶€ì",
                header_title_1: "ìƒí•˜ì´ ë¯¸ì‹ ê°€ì´ë“œ",
                header_title_2: "í˜„ì§€ AIì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”ã€‚",
                header_subtitle: "ë§ì¶¤ ì¶”ì²œì„ ë°›ê±°ë‚˜ ì—„ì„ ëœ ì»¬ë ‰ì…˜ì„ íƒìƒ‰í•˜ì„¸ìš”ã€‚",
                tab_ai: "AI ì¶”ì²œ",
                tab_guides: "ì—„ì„  ê°€ì´ë“œ",
                ai_chat_title: "Leyes AI ì±„íŒ…",
                ai_chat_greeting: "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ìƒí•˜ì´ ìš”ë¦¬ë¥¼ ìœ„í•œ í˜„ì§€ ê°€ì´ë“œ AIì…ë‹ˆë‹¤. ë¨¹ê³  ì‹¶ì€ ê²ƒì„ ì•Œë ¤ì£¼ì„¸ìš”:",
                ai_chat_tip_1: "\"ì™€ì´íƒ„ ê·¼ì²˜ ì €ë ´í•œ ê¸¸ê±°ë¦¬ ìŒì‹ì„ ì›í•´ìš”.\"",
                ai_chat_tip_2: "\"í”„ë‘ìŠ¤ ì¡°ê³„ì§€ì—ì„œ ë¡œë§¨í‹±í•œ ì €ë… ì‹ì‚¬ ì¥ì†Œë¥¼ ì¶”ì²œí•´ ì£¼ì„¸ìš”.\"",
                ai_chat_tip_3: "\"ìµœê³ ì˜ ìƒ¤ì˜¤ë¡±ë°”ì˜¤ëŠ” ì–´ë””ì„œ ì°¾ì„ ìˆ˜ ìˆë‚˜ìš”?\"",
                input_placeholder: "ì—¬ê¸°ì— ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: \"í˜¸í…” ê·¼ì²˜ ìµœê³ ì˜ êµ­ìˆ˜ì§‘\")",
                save_prompt_title: "Leyesë¥¼ ë°ìŠ¤í¬í†±ì— ì €ì¥",
                save_prompt_subtitle: "ì›í„°ì¹˜ ì•¡ì„¸ìŠ¤, ì—¬í–‰ì„ ê°„í¸í•˜ê²Œ",
                save_prompt_button: "ë°©ë²•",
                how_to_title: "í™ˆ í™”ë©´ì— ì¶”ê°€",
                how_to_subtitle: "í˜„ì§€ ê°€ì´ë“œë¥¼ ê°€ê¹Œì´ ë‘ì„¸ìš”ã€‚",
                how_to_step_1: " <span class='font-bold text-slate-900 underline italic'>ê³µìœ  ë²„íŠ¼</span> (iOS) ë˜ëŠ” <span class='font-bold text-slate-900 underline'>ë©”ë‰´ ì•„ì´ì½˜</span> (Android)ì„ íƒ­í•˜ì„¸ìš”ã€‚",
                how_to_step_2: "ì˜µì…˜ì—ì„œ <span class='font-bold text-slate-900 italic'>â€œí™ˆ í™”ë©´ì— ì¶”ê°€â€</span>ë¥¼ ì„ íƒí•˜ì„¸ìš”ã€‚",
                how_to_got_it: "ì•Œê² ìŠµë‹ˆë‹¤ï¼"
            }
        };
        let currentLang = 'zh'; 

        // === æ”»ç•¥å¡ç‰‡æ•°æ® (ç”¨äº Tab 2) ===
        const guidesData = [
            {
                id: 'food_noodles',
                name: { zh: "è€ä¸Šæµ·çš„åç¢—é¢", en: "Ten Classic Shanghai Noodles", ja: "ä¸Šæµ·ã®ä¼çµ±çš„ãªéººæ–™ç†10é¸", ko: "ìƒí•˜ì´ 10ëŒ€ ì „í†µ êµ­ìˆ˜" },
                category: { zh: "æœ¬åœ°ç»å…¸", en: "Local Classics", ja: "ãƒ­ãƒ¼ã‚«ãƒ«åç‰©", ko: "í˜„ì§€ í´ë˜ì‹" },
                description: { 
                    zh: "ç²¾é€‰åå®¶æœ¬åœ°äººä»å°åƒåˆ°å¤§çš„é¢é¦†ï¼Œä¸€å£å…¥é­‚ã€‚", 
                    en: "Ten noodle shops locals swear by, offering a taste of authentic Shanghai.",
                    ja: "åœ°å…ƒæ°‘ãŒæ„›ã™ã‚‹é¢å±‹10é¸ã€‚é­‚ã‚’æºã•ã¶ã‚‹ä¸€æ¯ã€‚",
                    ko: "í˜„ì§€ì¸ë“¤ì´ ì–´ë¦´ ë•Œë¶€í„° ë¨¹ì–´ì˜¨ êµ­ìˆ˜ì§‘ 10ê³³ã€‚ í•œ ì…ì— ê°ë™ì„ ì„ ì‚¬í•©ë‹ˆë‹¤ã€‚" 
                },
                image: "https://images.unsplash.com/photo-1547372076-4d0092306915?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNTkyOTN8MHwxfHNlYXJjaHwyM3x8c2hhbmdoYWklMjBub29kbGVzfGVufDB8fHx8MTY3ODkzMDExM3ww&ixlib=rb-4.0.3&q=80&w=400",
                color: "bg-red-600",
                colorLight: "bg-red-100",
            },
            {
                id: 'food_cafe',
                name: { zh: "æ³•ç§Ÿç•Œå’–å•¡åœ°å›¾", en: "French Concession Cafe Map", ja: "ãƒ•ãƒ©ãƒ³ã‚¹ç§Ÿç•Œã‚«ãƒ•ã‚§ãƒãƒƒãƒ—", ko: "í”„ë‘ìŠ¤ ì¡°ê³„ì§€ ì¹´í˜ ì§€ë„" },
                category: { zh: "å’–å•¡æŒ‡å—", en: "Cafe Guide", ja: "ã‚«ãƒ•ã‚§ã‚¬ã‚¤ãƒ‰", ko: "ì¹´í˜ ê°€ì´ë“œ" },
                description: { 
                    zh: "æ¢§æ¡æ ‘ä¸‹çš„ç²¾å“å’–å•¡åº—ï¼Œäº«å—ä¼˜é›…çš„åˆåæ—¶å…‰ã€‚", 
                    en: "Boutique cafes under the parasol trees, perfect for a relaxing afternoon.",
                    ja: "ãƒ—ãƒ©ã‚¿ãƒŠã‚¹ã®æœ¨é™°ã«ã‚ã‚‹ãŠã—ã‚ƒã‚Œãªã‚«ãƒ•ã‚§ã§å„ªé›…ãªåˆå¾Œã‚’ã€‚",
                    ko: "í”Œë¼íƒ€ë„ˆìŠ¤ ë‚˜ë¬´ ì•„ë˜ ë¶€í‹°í¬ ì¹´í˜ì—ì„œ ìš°ì•„í•œ ì˜¤í›„ë¥¼ ì¦ê¸°ì„¸ìš”ã€‚" 
                },
                image: "https://images.unsplash.com/photo-1596707325257-25e1740b2f5b?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNTkyOTN8MHwxfHNlYXJjaHwyMHx8Y29mZmVlJTIwc2hhbmdoYWl8ZW58MHx8fHx8MTY3ODkzMDExM3ww&ixlib=rb-4.0.3&q=80&w=400",
                color: "bg-amber-600",
                colorLight: "bg-amber-100",
            }
            // æ›´å¤šæ”»ç•¥å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
        ];


        // === æ ¸å¿ƒå‡½æ•° ===
        
        function setLanguage(lang) {
            currentLang = lang;
            const currentTrans = translations[lang];

            localStorage.setItem('leyesLang', lang); 

            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (currentTrans[key]) {
                    el.innerHTML = currentTrans[key];
                }
            });

            document.querySelectorAll('[data-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-key-placeholder');
                if (currentTrans[key]) {
                    el.placeholder = currentTrans[key];
                }
            });
            
            renderGuides(); 
            
            document.getElementById('lang-selector').value = lang;
            
            const greetingElement = document.querySelector('[data-key="ai_chat_greeting"]');
            if (greetingElement) {
                greetingElement.innerHTML = translations[currentLang].ai_chat_greeting;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('border-blue-600', 'text-blue-600');
                el.classList.add('border-transparent', 'text-slate-500', 'hover:text-slate-700');
            });

            const inputArea = document.getElementById('chat-input-area-fixed'); 

            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const activeTabButton = document.getElementById(`tab-${tabName}`);
            activeTabButton.classList.add('border-blue-600', 'text-blue-600');
            activeTabButton.classList.remove('border-transparent', 'text-slate-500', 'hover:text-slate-700');
            
            if (tabName === 'ai') {
                inputArea.classList.remove('hidden');
            } else {
                inputArea.classList.add('hidden');
            }
        }

        function generateGuideCard(guide) {
            const link = `#`; 
            const currentTrans = translations[currentLang];

            return `
                <a href="${link}" class="group bg-white rounded-3xl shadow-lg p-6 flex flex-col md:flex-row gap-6 border border-slate-100 hover:shadow-xl transition-shadow duration-300 active:scale-[0.99]">
                    <img src="${guide.image}" alt="${guide.name[currentLang]}" class="w-full md:w-64 h-48 md:h-64 object-cover rounded-2xl flex-shrink-0 transition-transform group-hover:scale-[1.02] duration-500">
                    <div class="flex flex-col justify-between">
                        <div>
                            <span class="text-xs font-bold ${guide.color.replace('bg-', 'text-')} uppercase tracking-widest ${guide.colorLight} px-3 py-1 rounded-full">${guide.category[currentLang]}</span>
                            <h4 class="text-2xl font-black mt-2">${guide.name[currentLang]}</h4>
                            <p class="text-slate-600 mt-1">${guide.description[currentLang]}</p>
                        </div>
                        <div class="mt-4">
                            <span class="inline-flex items-center gap-2 text-blue-600 font-bold">
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                ${currentTrans.tab_guides} 
                            </span>
                        </div>
                    </div>
                </a>
            `;
        }

        function renderGuides() {
            const container = document.getElementById('guides-container');
            if (!container) return; 

            container.innerHTML = ''; 
            
            guidesData.forEach(guide => {
                container.insertAdjacentHTML('beforeend', generateGuideCard(guide));
            });

            lucide.createIcons();
        }

        function toggleInstructions(show) {
            const modal = document.getElementById('instructions-modal');
            if (show) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatHistory = document.getElementById('chat-history');
        const welcomeContainer = document.getElementById('welcome-message-container');


        // è¾…åŠ©å‡½æ•°ï¼šæ¶ˆæ¯æ°”æ³¡ç”Ÿæˆ
        function appendMessage(text, sender, isLoading = false) {
            const msgDiv = document.createElement('div');
            const baseClass = 'max-w-[80%] p-4 rounded-xl shadow-md animate-slide-up'; 
            
            if (sender === 'user') {
                msgDiv.className = `${baseClass} bg-blue-500 text-white ml-auto rounded-br-none`;
                msgDiv.textContent = text;
            } else if (sender === 'ai') {
                msgDiv.className = `${baseClass} bg-white text-slate-800 rounded-tl-none`;
                if (isLoading) {
                    msgDiv.innerHTML = '<div class="animate-pulse">...</div>'; 
                } else {
                    msgDiv.innerHTML = text; 
                }
            } else if (sender === 'error') {
                msgDiv.className = `${baseClass} bg-red-100 text-red-700 mx-auto`;
                msgDiv.innerHTML = text;
            }

            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; 
            return msgDiv; 
        }
        
        /**
         * æ ¼å¼åŒ– AI è¿”å›çš„æ–‡æœ¬ï¼Œä¸»è¦å¤„ç†æ¢è¡Œç¬¦
         */
        function formatAiResponse(text) {
            // åŸºç¡€çš„ Markdown æ ¼å¼åŒ– (å¦‚æœ AI è¿”å›ç²—ä½“ï¼Œè¿™é‡Œä¼šå¤„ç†)
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
            // å°†æ¢è¡Œç¬¦æ›¿æ¢ä¸º <br> ä»¥ä¾¿åœ¨ HTML ä¸­æ­£ç¡®æ˜¾ç¤º
            text = text.replace(/(\r\n|\n\r|\n|\r)/g, '<br>'); 
            return text;
        }

        // ğŸŒŸğŸŒŸ æ ¸å¿ƒä¿®æ”¹ï¼šå®ç°æµå¼ä¼ è¾“å¤„ç† ğŸŒŸğŸŒŸ
        // ğŸŒŸğŸŒŸ ä¿®æ­£åçš„æ ¸å¿ƒä¿®æ”¹ï¼šå®ç°æµå¼ä¼ è¾“å¤„ç† ğŸŒŸğŸŒŸ
        async function streamAiResponse(userMessage) {
            const aiMessageDiv = appendMessage('...', 'ai', true); 
            const historyElement = document.getElementById('chat-history');
            
            let accumulatedText = '';
            let errorOccurred = false;
            
            // ç¡®ä¿åœ¨æ¯æ¬¡æ–°çš„æµå¼è¿æ¥å‰ï¼Œç¦ç”¨è¾“å…¥æ¡†
            userInput.disabled = true;

            try {
                // ç¡®ä¿ API_URL æŒ‡å‘æ‚¨çš„åç«¯æœåŠ¡
                const API_URL = '/api/chat'; 

                const response = await fetch(API_URL, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMessage, language: currentLang }),
                });

                if (!response.ok || !response.body) {
                    // å¦‚æœ HTTP çŠ¶æ€ç ä¸æ˜¯ 2xx (åŒ…æ‹¬ CORS é”™è¯¯æˆ– 4xx/5xx)
                    const errorDetails = response.statusText || 'è¿æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯ CORS æˆ– HTTP é”™è¯¯ã€‚';
                    throw new Error(`HTTP Error ${response.status}: ${errorDetails}`);
                }

                // 2. å¯ç”¨æµå¼é˜…è¯»å™¨ (TextDecoder ç”¨äºå°†å­—èŠ‚æµè½¬æ¢ä¸ºå­—ç¬¦ä¸²)
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = '';

                // 3. å¾ªç¯è¯»å–æ•°æ®å—
                while (true) {
                    const { value, done } = await reader.read();
                    
                    // ğŸš¨ ä¿®å¤ 1ï¼šåœ¨ done ä¸º true æ—¶ç«‹å³ä¸­æ–­å¾ªç¯ ğŸš¨
                    if (done) {
                        break; 
                    }
                    
                    // ğŸš¨ ä¿®å¤ 2ï¼šç¡®ä¿ value å­˜åœ¨ï¼Œå¦åˆ™è·³è¿‡ ğŸš¨
                    if (!value) {
                        continue;
                    }

                    // è§£ç æ”¶åˆ°çš„æ–°æ•°æ®å—
                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split('\n');
                    buffer = lines.pop(); // æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´ï¼Œæ”¾å› buffer

                    // å¤„ç†å®Œæ•´çš„ SSE æ•°æ®è¡Œ
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6).trim(); // trim ç¡®ä¿å»é™¤ç©ºæ ¼
                            if (data.length > 0) {
                                try {
                                    const json = JSON.parse(data);

                                    if (json.error) {
                                        accumulatedText += `é”™è¯¯ï¼š${json.error}`;
                                        errorOccurred = true;
                                    } else if (json.end) {
                                        break; 
                                    } else if (json.text) {
                                        accumulatedText += json.text;
                                    }
                                    
                                    // å®æ—¶æ›´æ–° AI æ¶ˆæ¯æ¡†çš„å†…å®¹
                                    aiMessageDiv.innerHTML = formatAiResponse(accumulatedText);
                                    historyElement.scrollTop = historyElement.scrollHeight; 

                                } catch (e) {
                                    // å¿½ç•¥æ— æ•ˆæˆ–ä¸å®Œæ•´çš„ JSON å—
                                    continue; 
                                }
                            }
                        }
                    }
                }
                
                // æœ€ç»ˆæ¸…ç†å’Œæ ¼å¼åŒ–
                aiMessageDiv.innerHTML = formatAiResponse(accumulatedText);
                if (errorOccurred) {
                    aiMessageDiv.classList.add('bg-red-100', 'text-red-700');
                }

            } catch (error) {
                console.error('Stream Fetch error:', error);
                aiMessageDiv.innerHTML = `ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯ï¼šæ— æ³•å»ºç«‹æµå¼è¿æ¥ã€‚è¯·æ£€æŸ¥æ‚¨çš„ Node.js åç«¯æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œåœ¨ **http://localhost:3000**ã€‚(${error.message})`;
                aiMessageDiv.classList.add('bg-red-100', 'text-red-700');
            } finally {
                // ç¡®ä¿æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½é‡æ–°å¯ç”¨è¾“å…¥æ¡†
                userInput.disabled = false;
                userInput.focus();
            }
        }
        // ğŸŒŸğŸŒŸ æµå¼ä¼ è¾“å¤„ç†ç»“æŸ ğŸŒŸğŸŒŸ
        // ğŸŒŸğŸŒŸ æµå¼ä¼ è¾“å¤„ç†ç»“æŸ ğŸŒŸğŸŒŸ

        
        // è¡¨å•æäº¤äº‹ä»¶å¤„ç†å™¨ (å·²ä¿®æ”¹)
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = userInput.value.trim();
            if (message) {
                
                // ğŸŒŸ ä¼˜åŒ– 1: éšè—æ¬¢è¿æç¤ºæ¡† ğŸŒŸ
                if (welcomeContainer) {
                    welcomeContainer.classList.add('hidden');
                }
                
                // ğŸŒŸ ä¼˜åŒ– 2: ç«‹å³æ˜¾ç¤ºç”¨æˆ·å‘é€çš„æ¶ˆæ¯ ğŸŒŸ
                appendMessage(message, 'user');
                
                userInput.value = '';
                
                // ğŸŒŸ è°ƒç”¨æµå¼å¤„ç†å‡½æ•° ğŸŒŸ
                streamAiResponse(message).finally(() => {
                    // ç»“æŸåé‡æ–°å¯ç”¨è¾“å…¥
                    userInput.disabled = false;
                    userInput.focus();
                });
            }
        });


        // é¡µé¢åŠ è½½å’Œåˆå§‹åŒ– (è¯»å– localStorage, æ˜¾ç¤ºé¡¶éƒ¨ Banner)
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('leyesLang') || 'zh'; 
            currentLang = savedLang; 
            
            setLanguage(currentLang); 
            switchTab('ai');

            setTimeout(() => {
                const prompt = document.getElementById('top-save-prompt');
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    prompt.classList.add('show-prompt');
                    prompt.classList.remove('pointer-events-none');
                }
            }, 2000);
            
            lucide.createIcons();
        });
    </script>
</body>
</html>
